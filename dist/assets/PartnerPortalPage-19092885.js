import{n as ce,k as oe,r as i,j as e,q as l,I as d,B as u}from"./index-5172b808.js";import{P as de}from"./PageHeader-86e231d5.js";import{C as p,a as _,b,e as g,c as k}from"./card-99b7e505.js";import{L as c}from"./label-676e1367.js";import{T as se}from"./textarea-b8d8d674.js";import{T as ue,a as me,b as L,c as T}from"./tabs-42c694cf.js";const B=r=>{const t=Number(r);return Number.isFinite(t)?t:null},ve=()=>{const{user:r}=ce(),{toast:t}=oe(),[N,w]=i.useState(!0),[q,P]=i.useState(!1),[n,m]=i.useState({full_name:"",phone:"",bank_account_name:"",bank_name:"",bank_account_number:"",bank_branch:"",payout_notes:""}),[A,M]=i.useState(!1),[O,$]=i.useState(!1),[j,U]=i.useState([]),[H,F]=i.useState(!1),[W,I]=i.useState(null),[h,S]=i.useState({category:"motorbike",name:"",description:"",image_url:""}),[E,R]=i.useState([]),[o,y]=i.useState({vehicle_id:"",start_date:"",end_date:"",reason:""}),[Y,V]=i.useState(!1),[z,G]=i.useState(null),[D,K]=i.useState([]),[Q,J]=i.useState(!1),X=i.useMemo(()=>j.filter(a=>a.listing_status==="approved"&&a.active),[j]),x=async()=>{if(!l||!r){w(!1);return}w(!0),P(!1);const[a,s]=await Promise.all([l.from("owner_profiles").select("*").eq("user_id",r.id).maybeSingle(),l.from("vehicles").select("id, category, name, description, image_url, active, listing_status, submitted_at, approved_at, rejected_at, rejection_reason, price_per_day, created_at").eq("owner_user_id",r.id).order("created_at",{ascending:!1})]),v=a.error?.message||s.error?.message;if(v&&/relation .* does not exist|column .* does not exist/i.test(v)){P(!0),w(!1);return}a.error?t({title:"Could not load payout profile",description:a.error.message,variant:"destructive"}):a.data&&(m({full_name:a.data.full_name||"",phone:a.data.phone||"",bank_account_name:a.data.bank_account_name||"",bank_name:a.data.bank_name||"",bank_account_number:a.data.bank_account_number||"",bank_branch:a.data.bank_branch||"",payout_notes:a.data.payout_notes||""}),M(!!a.data.insurance_ack_at)),s.error?(t({title:"Could not load your vehicles",description:s.error.message,variant:"destructive"}),U([])):(U(s.data||[]),y(f=>{if(f.vehicle_id)return f;const C=(s.data||[]).find(ae=>ae.listing_status==="approved"&&ae.active);return{...f,vehicle_id:C?.id||""}}));const ee=(s.data||[]).map(f=>f.id).filter(Boolean);if(ee.length===0)R([]);else{const{data:f,error:C}=await l.from("vehicle_unavailability").select("id, vehicle_id, start_date, end_date, reason, created_at").in("vehicle_id",ee).order("start_date",{ascending:!0});if(C){if(/relation .* does not exist|column .* does not exist/i.test(C.message)){P(!0),w(!1);return}t({title:"Could not load availability blocks",description:C.message,variant:"destructive"}),R([])}else R(f||[])}w(!1)},Z=async()=>{if(!l||!r)return;J(!0);const{data:a,error:s}=await l.from("payouts").select("id, booking_id, gross_amount, platform_fee_amount, net_amount, eligible_at, status, paid_at, payment_reference, created_at").eq("owner_user_id",r.id).order("created_at",{ascending:!1});s?(/relation .* does not exist/i.test(s.message)?P(!0):t({title:"Could not load payouts",description:s.message,variant:"destructive"}),K([])):K(a||[]),J(!1)};i.useEffect(()=>{x()},[r?.id]),i.useEffect(()=>{Z()},[r?.id]);const te=async()=>{if(!l||!r)return;$(!0);const a={user_id:r.id,full_name:n.full_name||null,phone:n.phone||null,bank_account_name:n.bank_account_name||null,bank_name:n.bank_name||null,bank_account_number:n.bank_account_number||null,bank_branch:n.bank_branch||null,payout_notes:n.payout_notes||null,insurance_ack_at:A?new Date().toISOString():null,updated_at:new Date().toISOString()},{error:s}=await l.from("owner_profiles").upsert(a,{onConflict:"user_id"});t(s?{title:"Save failed",description:s.message,variant:"destructive"}:{title:"Saved",description:"Payout details updated.",className:"bg-blue-500 text-white"}),$(!1)},ne=async()=>{if(!l||!r)return;const a=h.name.trim();if(!a){t({title:"Name required",description:"Enter a vehicle name.",variant:"destructive"});return}if(!A){t({title:"Insurance required",description:"Please confirm you have the required insurance before submitting vehicles.",variant:"destructive"});return}const{error:s}=await l.from("owner_profiles").upsert({user_id:r.id,full_name:n.full_name||null,phone:n.phone||null,bank_account_name:n.bank_account_name||null,bank_name:n.bank_name||null,bank_account_number:n.bank_account_number||null,bank_branch:n.bank_branch||null,payout_notes:n.payout_notes||null,insurance_ack_at:new Date().toISOString(),updated_at:new Date().toISOString()},{onConflict:"user_id"});if(s){t({title:"Could not save payout profile",description:s.message,variant:"destructive"});return}F(!0);const{error:v}=await l.from("vehicles").insert([{owner_user_id:r.id,category:h.category,name:a,description:h.description.trim()||null,image_url:h.image_url.trim()||null,inventory_count:1,active:!1,listing_status:"draft",price_per_day:null}]);if(v){t({title:"Create failed",description:v.message,variant:"destructive"}),F(!1);return}t({title:"Created",description:"Vehicle saved as draft.",className:"bg-blue-500 text-white"}),S({category:"motorbike",name:"",description:"",image_url:""}),await x(),F(!1)},le=async a=>{if(!l)return;I(a);const{error:s}=await l.rpc("submit_vehicle_for_approval",{p_vehicle_id:a});if(s){t({title:"Submit failed",description:s.message,variant:"destructive"}),I(null);return}t({title:"Submitted",description:"We will review and set pricing.",className:"bg-blue-500 text-white"}),await x(),I(null)},ie=async()=>{if(!l||!r)return;if(!o.vehicle_id){t({title:"Choose a vehicle",description:"Select a vehicle first.",variant:"destructive"});return}if(!o.start_date||!o.end_date){t({title:"Dates required",description:"Select a start and end date.",variant:"destructive"});return}if(o.end_date<=o.start_date){t({title:"Invalid dates",description:"End date must be after start date.",variant:"destructive"});return}V(!0);const{error:a}=await l.from("vehicle_unavailability").insert([{vehicle_id:o.vehicle_id,start_date:o.start_date,end_date:o.end_date,reason:o.reason.trim()||null,created_by:r.id}]);if(a){t({title:"Could not save block",description:a.message,variant:"destructive"}),V(!1);return}t({title:"Saved",description:"Availability updated.",className:"bg-blue-500 text-white"}),y(s=>({...s,start_date:"",end_date:"",reason:""})),await x(),V(!1)},re=async a=>{if(!l)return;G(a);const{error:s}=await l.from("vehicle_unavailability").delete().eq("id",a);s?t({title:"Delete failed",description:s.message,variant:"destructive"}):(t({title:"Removed",description:"Block deleted.",className:"bg-blue-500 text-white"}),await x()),G(null)};return e.jsxs("div",{className:"bg-gray-50",children:[e.jsx(de,{title:"Partner Portal",subtitle:"List your vehicle, manage availability, and track payouts.",breadcrumbs:[{name:"Home",link:"/"},{name:"Dashboard",link:"/dashboard"},{name:"Partner Portal"}]}),e.jsxs("main",{className:"container mx-auto px-4 py-12 space-y-6",children:[!l&&e.jsx(p,{className:"shadow-lg",children:e.jsxs(_,{children:[e.jsx(b,{children:"Supabase not configured"}),e.jsx(g,{children:"Set VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY to enable the partner portal."})]})}),l&&q&&e.jsx(p,{className:"shadow-lg border border-yellow-200",children:e.jsxs(_,{children:[e.jsx(b,{children:"Marketplace schema not installed"}),e.jsxs(g,{children:["Run ",e.jsx("code",{children:"supabase/partner_marketplace_schema.sql"})," in the Supabase SQL editor, then refresh this page."]})]})}),l&&!q&&e.jsxs(ue,{defaultValue:"vehicles",className:"w-full",children:[e.jsxs(me,{className:"grid w-full grid-cols-1 sm:grid-cols-3 bg-white shadow-sm",children:[e.jsx(L,{value:"vehicles",children:"My Vehicles"}),e.jsx(L,{value:"availability",children:"Availability"}),e.jsx(L,{value:"payouts",children:"Payouts"})]}),e.jsxs(T,{value:"vehicles",className:"mt-6 space-y-6",children:[e.jsxs(p,{className:"shadow-lg",children:[e.jsxs(_,{children:[e.jsx(b,{children:"Payout details (bank transfer)"}),e.jsx(g,{children:"We pay 70% to the owner, 7 days after the rental is completed. Owners are responsible for insurance."})]}),e.jsxs(k,{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(c,{htmlFor:"full_name",children:"Full name"}),e.jsx(d,{id:"full_name",value:n.full_name,onChange:a=>m(s=>({...s,full_name:a.target.value}))})]}),e.jsxs("div",{children:[e.jsx(c,{htmlFor:"phone",children:"Phone"}),e.jsx(d,{id:"phone",value:n.phone,onChange:a=>m(s=>({...s,phone:a.target.value}))})]}),e.jsxs("div",{children:[e.jsx(c,{htmlFor:"bank_account_name",children:"Bank account name"}),e.jsx(d,{id:"bank_account_name",value:n.bank_account_name,onChange:a=>m(s=>({...s,bank_account_name:a.target.value}))})]}),e.jsxs("div",{children:[e.jsx(c,{htmlFor:"bank_name",children:"Bank name"}),e.jsx(d,{id:"bank_name",value:n.bank_name,onChange:a=>m(s=>({...s,bank_name:a.target.value}))})]}),e.jsxs("div",{children:[e.jsx(c,{htmlFor:"bank_account_number",children:"Bank account number"}),e.jsx(d,{id:"bank_account_number",value:n.bank_account_number,onChange:a=>m(s=>({...s,bank_account_number:a.target.value}))})]}),e.jsxs("div",{children:[e.jsx(c,{htmlFor:"bank_branch",children:"Branch (optional)"}),e.jsx(d,{id:"bank_branch",value:n.bank_branch,onChange:a=>m(s=>({...s,bank_branch:a.target.value}))})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(c,{htmlFor:"payout_notes",children:"Notes (optional)"}),e.jsx(se,{id:"payout_notes",value:n.payout_notes,onChange:a=>m(s=>({...s,payout_notes:a.target.value})),placeholder:"Anything we should know about payouts"})]}),e.jsxs("div",{className:"md:col-span-2 flex items-center justify-between gap-3",children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-800",children:[e.jsx("input",{type:"checkbox",checked:A,onChange:a=>M(a.target.checked)}),"I confirm I have the insurance required to rent out this vehicle."]}),e.jsx(u,{type:"button",onClick:te,disabled:O,className:"bg-blue-600 hover:bg-blue-700",children:O?"Saving…":"Save"})]})]})]}),e.jsxs(p,{className:"shadow-lg",children:[e.jsxs(_,{children:[e.jsx(b,{children:"Add a vehicle"}),e.jsx(g,{children:"We review and set the rental price. Drafts are not visible publicly."})]}),e.jsxs(k,{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(c,{htmlFor:"new_category",children:"Category"}),e.jsxs("select",{id:"new_category",className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm",value:h.category,onChange:a=>S(s=>({...s,category:a.target.value})),children:[e.jsx("option",{value:"motorbike",children:"Motorbike"}),e.jsx("option",{value:"car",children:"Car"})]})]}),e.jsxs("div",{children:[e.jsx(c,{htmlFor:"new_name",children:"Vehicle name"}),e.jsx(d,{id:"new_name",value:h.name,onChange:a=>S(s=>({...s,name:a.target.value})),placeholder:"e.g. Honda Airblade 2020"})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(c,{htmlFor:"new_desc",children:"Description (optional)"}),e.jsx(se,{id:"new_desc",value:h.description,onChange:a=>S(s=>({...s,description:a.target.value})),placeholder:"Condition, transmission, extras, etc."})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(c,{htmlFor:"new_image",children:"Image URL (optional)"}),e.jsx(d,{id:"new_image",value:h.image_url,onChange:a=>S(s=>({...s,image_url:a.target.value})),placeholder:"https://..."})]}),e.jsxs("div",{className:"md:col-span-2 flex gap-3",children:[e.jsx(u,{type:"button",onClick:ne,disabled:H,className:"bg-blue-600 hover:bg-blue-700",children:H?"Saving…":"Create draft"}),e.jsx(u,{type:"button",variant:"outline",onClick:x,disabled:N,children:"Refresh"})]})]})]}),e.jsxs(p,{className:"shadow-lg",children:[e.jsxs(_,{children:[e.jsx(b,{children:"My vehicles"}),e.jsx(g,{children:N?"Loading…":`${j.length} total`})]}),e.jsxs(k,{className:"space-y-4",children:[j.length===0&&e.jsx("p",{className:"text-gray-700",children:"No vehicles yet."}),j.map(a=>e.jsxs("div",{className:"p-4 bg-white border rounded-lg space-y-2",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-gray-900",children:a.name}),e.jsx("p",{className:"text-sm text-gray-600 capitalize",children:a.category}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Status: ",e.jsx("span",{className:"font-semibold",children:a.listing_status})]}),a.rejection_reason?e.jsxs("p",{className:"text-xs text-red-600",children:["Reason: ",a.rejection_reason]}):null]}),e.jsxs("div",{className:"text-sm text-gray-700",children:[a.price_per_day?e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold",children:"Price:"})," $",B(a.price_per_day),"/day"]}):e.jsx("p",{className:"text-gray-500",children:"Price: pending"}),e.jsx("p",{className:a.active?"text-green-700 font-semibold":"text-gray-600 font-semibold",children:a.active?"Active":"Inactive"})]})]}),a.description?e.jsx("p",{className:"text-sm text-gray-700",children:a.description}):null,e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsx(u,{type:"button",onClick:()=>le(a.id),disabled:W===a.id||!["draft","rejected"].includes(a.listing_status),className:"bg-blue-600 hover:bg-blue-700",children:W===a.id?"Submitting…":"Submit for approval"}),e.jsx(u,{type:"button",variant:"outline",onClick:x,disabled:N,children:"Refresh"})]})]},a.id))]})]})]}),e.jsxs(T,{value:"availability",className:"mt-6 space-y-6",children:[e.jsxs(p,{className:"shadow-lg",children:[e.jsxs(_,{children:[e.jsx(b,{children:"Block dates (owner-controlled availability)"}),e.jsx(g,{children:"Blocked dates make your vehicle unavailable for customer bookings."})]}),e.jsxs(k,{className:"grid grid-cols-1 md:grid-cols-4 gap-4 items-end",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(c,{htmlFor:"block_vehicle",children:"Vehicle"}),e.jsxs("select",{id:"block_vehicle",className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm",value:o.vehicle_id,onChange:a=>y(s=>({...s,vehicle_id:a.target.value})),children:[e.jsx("option",{value:"",children:"Select…"}),X.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]}),X.length===0?e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"You’ll be able to block dates after a vehicle is approved and active."}):null]}),e.jsxs("div",{children:[e.jsx(c,{htmlFor:"block_start",children:"Start"}),e.jsx(d,{id:"block_start",type:"date",value:o.start_date,onChange:a=>y(s=>({...s,start_date:a.target.value}))})]}),e.jsxs("div",{children:[e.jsx(c,{htmlFor:"block_end",children:"End"}),e.jsx(d,{id:"block_end",type:"date",value:o.end_date,onChange:a=>y(s=>({...s,end_date:a.target.value}))})]}),e.jsxs("div",{className:"md:col-span-4",children:[e.jsx(c,{htmlFor:"block_reason",children:"Reason (optional)"}),e.jsx(d,{id:"block_reason",value:o.reason,onChange:a=>y(s=>({...s,reason:a.target.value})),placeholder:"Maintenance, personal use, etc."})]}),e.jsxs("div",{className:"md:col-span-4 flex gap-3",children:[e.jsx(u,{type:"button",onClick:ie,disabled:Y||!o.vehicle_id,className:"bg-blue-600 hover:bg-blue-700",children:Y?"Saving…":"Add block"}),e.jsx(u,{type:"button",variant:"outline",onClick:x,disabled:N,children:"Refresh"})]})]})]}),e.jsxs(p,{className:"shadow-lg",children:[e.jsxs(_,{children:[e.jsx(b,{children:"Existing blocks"}),e.jsx(g,{children:N?"Loading…":`${E.length} total`})]}),e.jsxs(k,{className:"space-y-3",children:[E.length===0?e.jsx("p",{className:"text-gray-700",children:"No blocks."}):null,E.map(a=>{const s=j.find(v=>v.id===a.vehicle_id);return e.jsxs("div",{className:"p-4 bg-white border rounded-lg flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"font-semibold text-gray-900",children:s?.name||a.vehicle_id}),e.jsxs("p",{className:"text-gray-700",children:[a.start_date," → ",a.end_date]}),a.reason?e.jsx("p",{className:"text-gray-500",children:a.reason}):null]}),e.jsx(u,{type:"button",variant:"outline",onClick:()=>re(a.id),disabled:z===a.id,children:z===a.id?"Removing…":"Remove"})]},a.id)})]})]})]}),e.jsx(T,{value:"payouts",className:"mt-6 space-y-6",children:e.jsxs(p,{className:"shadow-lg",children:[e.jsxs(_,{children:[e.jsx(b,{children:"Payouts"}),e.jsx(g,{children:Q?"Loading…":`${D.length} total`})]}),e.jsxs(k,{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-700",children:e.jsxs("p",{children:["Owner share: ",e.jsx("span",{className:"font-semibold",children:"70%"}),". Eligible: ",e.jsx("span",{className:"font-semibold",children:"7 days"})," after completion."]})}),D.length===0?e.jsx("p",{className:"text-gray-700",children:"No payouts yet."}):null,D.map(a=>e.jsx("div",{className:"p-4 bg-white border rounded-lg",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between gap-2",children:[e.jsxs("div",{className:"text-sm",children:[e.jsxs("p",{className:"font-semibold text-gray-900",children:["Booking: ",e.jsx("code",{className:"break-all",children:a.booking_id})]}),e.jsxs("p",{className:"text-gray-700",children:["Status: ",e.jsx("span",{className:"font-semibold",children:a.status})]}),e.jsxs("p",{className:"text-gray-700",children:["Eligible at: ",e.jsx("span",{className:"font-semibold",children:a.eligible_at})]}),a.paid_at?e.jsxs("p",{className:"text-green-700 font-semibold",children:["Paid at: ",a.paid_at]}):null,a.payment_reference?e.jsxs("p",{className:"text-gray-600",children:["Ref: ",a.payment_reference]}):null]}),e.jsxs("div",{className:"text-sm text-gray-800",children:[e.jsxs("p",{children:["Gross: ",e.jsxs("span",{className:"font-semibold",children:["$",B(a.gross_amount)]})]}),e.jsxs("p",{children:["Fee (30%): ",e.jsxs("span",{className:"font-semibold",children:["$",B(a.platform_fee_amount)]})]}),e.jsxs("p",{children:["Net (70%): ",e.jsxs("span",{className:"font-semibold",children:["$",B(a.net_amount)]})]})]})]})},a.id)),e.jsx("div",{className:"flex gap-3",children:e.jsx(u,{type:"button",variant:"outline",onClick:Z,disabled:Q,children:"Refresh"})})]})]})})]})]})]})};export{ve as default};
