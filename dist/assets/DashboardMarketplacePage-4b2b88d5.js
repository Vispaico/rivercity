import{i as te,r,j as e,s as n,l as $,I as J,B as d,T as ie}from"./index-0f1908a9.js";import{P as ne}from"./PageHeader-5c60245d.js";import{T as re,a as le,b as A,c as T}from"./tabs-606a245e.js";import{C as u,a as p,b as x,e as g,c as w}from"./card-0cb8919b.js";const h=i=>{const c=Number(i);return Number.isFinite(c)?c:null},de=i=>{if(!i)return!1;const c=new Date(i);return Number.isFinite(c.getTime())&&c.getTime()<=Date.now()},pe=()=>{const{toast:i}=te(),[c,m]=r.useState(!1),[k,v]=r.useState(!0),[j,I]=r.useState([]),[E,M]=r.useState({}),[U,C]=r.useState(null),[D,P]=r.useState(null),[F,X]=r.useState({}),[q,S]=r.useState(!0),[O,z]=r.useState([]),[_,f]=r.useState(null),[H,B]=r.useState(!0),[R,V]=r.useState([]),[W,G]=r.useState(null),[K,Q]=r.useState({}),L=r.useMemo(()=>j.filter(s=>s.listing_status==="submitted"),[j]),b=async()=>{if(!n){v(!1);return}v(!0);const{data:s,error:a}=await n.from("vehicles").select("id, category, name, description, image_url, owner_user_id, listing_status, submitted_at, approved_at, rejected_at, rejection_reason, price_per_day, active, created_at").not("owner_user_id","is",null).order("submitted_at",{ascending:!1}).order("created_at",{ascending:!1});a?(/column .* does not exist|relation .* does not exist/i.test(a.message)&&m(!0),i({title:"Could not load partner listings",description:a.message,variant:"destructive"}),I([])):(m(!1),I(s||[]),M(t=>{const l={...t};for(const o of s||[])l[o.id]===void 0&&(l[o.id]=o.price_per_day??"");return l})),v(!1)},y=async()=>{if(!n){S(!1);return}S(!0);const{data:s,error:a}=await n.from("bookings").select("id, start_date, end_date, status, created_at, completed_at, intake, booking_items(id, quantity, unit_price_per_day, vehicle_owner_user_id, vehicles(id, name, category, owner_user_id))").order("created_at",{ascending:!1}).limit(50);a?(/column .* does not exist|relation .* does not exist/i.test(a.message)&&m(!0),i({title:"Could not load bookings",description:a.message,variant:"destructive"}),z([])):(m(!1),z(s||[])),S(!1)},N=async()=>{if(!n){B(!1);return}B(!0);const{data:s,error:a}=await n.from("payouts").select("id, booking_id, owner_user_id, gross_amount, platform_fee_amount, net_amount, eligible_at, status, paid_at, payment_reference, created_at, owner_profiles(full_name, phone, bank_account_name, bank_name, bank_account_number, bank_branch, payout_notes)").order("created_at",{ascending:!1}).limit(100);a?(/relation .* does not exist/i.test(a.message)&&m(!0),i({title:"Could not load payouts",description:a.message,variant:"destructive"}),V([])):(m(!1),V(s||[]),Q(t=>{const l={...t};for(const o of s||[])l[o.id]===void 0&&(l[o.id]=o.payment_reference??"");return l})),B(!1)};r.useEffect(()=>{b(),y(),N()},[]);const Z=async s=>{if(!n)return;const a=E[s],t=h(a);if(!t||t<=0){i({title:"Price required",description:"Enter a valid price/day.",variant:"destructive"});return}C(s);const{error:l}=await n.rpc("approve_vehicle_listing",{p_vehicle_id:s,p_price_per_day:t});if(l){i({title:"Approve failed",description:l.message,variant:"destructive"}),C(null);return}i({title:"Approved",description:"Listing is now public & bookable.",className:"bg-blue-500 text-white"}),await b(),C(null)},ee=async s=>{if(!n)return;P(s);const a=(F[s]||"").trim()||null,{error:t}=await n.rpc("reject_vehicle_listing",{p_vehicle_id:s,p_reason:a});if(t){i({title:"Reject failed",description:t.message,variant:"destructive"}),P(null);return}i({title:"Rejected",description:"Owner can edit and resubmit.",className:"bg-blue-500 text-white"}),await b(),P(null)},Y=async(s,a)=>{if(!n)return;f(s);const{error:t}=await n.rpc("set_booking_status",{p_booking_id:s,p_status:a});t?i({title:"Update failed",description:t.message,variant:"destructive"}):(i({title:"Updated",description:`Booking marked ${a}.`,className:"bg-blue-500 text-white"}),await y()),f(null)},se=async s=>{if(!n)return;f(s);const{error:a}=await n.rpc("complete_booking_and_create_payouts",{p_booking_id:s});a?i({title:"Complete failed",description:a.message,variant:"destructive"}):(i({title:"Completed",description:"Payouts created (eligible in 7 days).",className:"bg-blue-500 text-white"}),await Promise.all([y(),N()])),f(null)},ae=async s=>{if(!n)return;G(s);const a=(K[s]||"").trim()||null,{error:t}=await n.rpc("mark_payout_paid",{p_payout_id:s,p_payment_reference:a});t?i({title:"Mark paid failed",description:t.message,variant:"destructive"}):(i({title:"Paid",description:"Payout marked as paid.",className:"bg-blue-500 text-white"}),await N()),G(null)};return e.jsxs("div",{className:"bg-gray-50",children:[e.jsx(ne,{title:"Marketplace Admin",subtitle:"Approve partner listings, manage bookings, and track manual payouts.",breadcrumbs:[{name:"Home",link:"/"},{name:"Dashboard",link:"/dashboard"},{name:"Marketplace"}]}),e.jsxs("main",{className:"container mx-auto px-4 py-12 space-y-6",children:[!n&&e.jsx(u,{className:"shadow-lg",children:e.jsxs(p,{children:[e.jsx(x,{children:"Supabase not configured"}),e.jsx(g,{children:"Set VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY to enable marketplace admin tools."})]})}),n&&c&&e.jsx(u,{className:"shadow-lg border border-yellow-200",children:e.jsxs(p,{children:[e.jsx(x,{children:"Marketplace schema not installed"}),e.jsxs(g,{children:["Run ",e.jsx("code",{children:"supabase/partner_marketplace_schema.sql"})," in the Supabase SQL editor, then refresh."]})]})}),n&&!c&&e.jsxs(re,{defaultValue:"listings",className:"w-full",children:[e.jsxs(le,{className:"grid w-full grid-cols-1 sm:grid-cols-3 bg-white shadow-sm",children:[e.jsx(A,{value:"listings",children:"Listings"}),e.jsx(A,{value:"bookings",children:"Bookings"}),e.jsx(A,{value:"payouts",children:"Payouts"})]}),e.jsxs(T,{value:"listings",className:"mt-6 space-y-6",children:[e.jsxs(u,{className:"shadow-lg",children:[e.jsxs(p,{children:[e.jsx(x,{children:"Submitted listings"}),e.jsx(g,{children:k?"Loading…":`${L.length} submitted`})]}),e.jsxs(w,{className:"space-y-4",children:[L.length===0?e.jsx("p",{className:"text-gray-700",children:"No pending submissions."}):null,L.map(s=>e.jsxs("div",{className:"p-4 bg-white border rounded-lg space-y-3",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-start md:justify-between gap-3",children:[e.jsxs("div",{className:"flex gap-4",children:[s.image_url?e.jsx("img",{src:s.image_url,alt:s.name,className:"h-16 w-24 object-cover rounded-md border",loading:"lazy"}):e.jsx("div",{className:"h-16 w-24 rounded-md border bg-gray-100"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-gray-900",children:s.name}),e.jsx("p",{className:"text-sm text-gray-600 capitalize",children:s.category}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Owner: ",e.jsx("code",{className:"break-all",children:s.owner_user_id})]}),s.description?e.jsx("p",{className:"text-sm text-gray-700 mt-1",children:s.description}):null]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3 items-end",children:[e.jsxs("div",{children:[e.jsx($,{htmlFor:`price_${s.id}`,children:"Price/day (USD)"}),e.jsx(J,{id:`price_${s.id}`,type:"number",min:0,value:E[s.id]??"",onChange:a=>M(t=>({...t,[s.id]:a.target.value}))})]}),e.jsx("div",{className:"flex gap-2",children:e.jsx(d,{type:"button",onClick:()=>Z(s.id),disabled:U===s.id,className:"bg-blue-600 hover:bg-blue-700",children:U===s.id?"Approving…":"Approve"})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx($,{htmlFor:`reject_${s.id}`,children:"Reject reason (optional)"}),e.jsx(ie,{id:`reject_${s.id}`,value:F[s.id]??"",onChange:a=>X(t=>({...t,[s.id]:a.target.value})),placeholder:"What needs to be fixed before approval?"})]}),e.jsx("div",{className:"flex items-end",children:e.jsx(d,{type:"button",variant:"outline",onClick:()=>ee(s.id),disabled:D===s.id,children:D===s.id?"Rejecting…":"Reject"})})]})]},s.id)),e.jsx("div",{className:"flex gap-3",children:e.jsx(d,{type:"button",variant:"outline",onClick:b,disabled:k,children:"Refresh"})})]})]}),e.jsxs(u,{className:"shadow-lg",children:[e.jsxs(p,{children:[e.jsx(x,{children:"All partner listings"}),e.jsx(g,{children:k?"Loading…":`${j.length} total`})]}),e.jsx(w,{className:"space-y-3",children:j.map(s=>e.jsxs("div",{className:"p-4 bg-white border rounded-lg flex flex-col sm:flex-row sm:justify-between gap-2",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"font-semibold text-gray-900",children:s.name}),e.jsxs("p",{className:"text-gray-600 capitalize",children:[s.category," · ",e.jsx("span",{className:"font-semibold",children:s.listing_status})]}),s.rejection_reason?e.jsxs("p",{className:"text-red-600",children:["Reason: ",s.rejection_reason]}):null]}),e.jsxs("div",{className:"text-sm text-gray-800",children:[e.jsxs("p",{children:["Price: ",e.jsx("span",{className:"font-semibold",children:s.price_per_day?`$${h(s.price_per_day)}/day`:"—"})]}),e.jsx("p",{className:s.active?"text-green-700 font-semibold":"text-gray-600 font-semibold",children:s.active?"Active":"Inactive"})]})]},s.id))})]})]}),e.jsx(T,{value:"bookings",className:"mt-6 space-y-6",children:e.jsxs(u,{className:"shadow-lg",children:[e.jsxs(p,{children:[e.jsx(x,{children:"Recent bookings"}),e.jsx(g,{children:q?"Loading…":`${O.length} shown`})]}),e.jsxs(w,{className:"space-y-4",children:[O.map(s=>e.jsxs("div",{className:"p-4 bg-white border rounded-lg space-y-3",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:justify-between gap-3",children:[e.jsxs("div",{className:"text-sm",children:[e.jsxs("p",{className:"font-semibold text-gray-900",children:["Booking ",e.jsx("code",{className:"break-all",children:s.id})]}),e.jsxs("p",{className:"text-gray-700",children:[s.start_date," → ",s.end_date]}),e.jsxs("p",{className:"text-gray-700",children:["Status: ",e.jsx("span",{className:"font-semibold",children:s.status})]}),s.completed_at?e.jsxs("p",{className:"text-green-700 font-semibold",children:["Completed at: ",s.completed_at]}):null]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(d,{type:"button",variant:"outline",onClick:()=>Y(s.id,"confirmed"),disabled:_===s.id,children:"Confirm"}),e.jsx(d,{type:"button",variant:"outline",onClick:()=>Y(s.id,"cancelled"),disabled:_===s.id,children:"Cancel"}),e.jsx(d,{type:"button",onClick:()=>se(s.id),disabled:_===s.id,className:"bg-blue-600 hover:bg-blue-700",children:_===s.id?"Working…":"Complete + create payouts"})]})]}),e.jsxs("div",{className:"text-sm text-gray-800",children:[e.jsx("p",{className:"font-semibold",children:"Items"}),e.jsx("ul",{className:"mt-2 space-y-1",children:(s.booking_items||[]).map(a=>{const t=a.vehicles,l=!!t?.owner_user_id;return e.jsxs("li",{className:"flex flex-col sm:flex-row sm:justify-between gap-1",children:[e.jsxs("span",{children:[t?.name||a.vehicle_id," × ",a.quantity," ",l?"(Partner)":"(Rivercity)"]}),a.unit_price_per_day?e.jsxs("span",{children:["$",h(a.unit_price_per_day),"/day"]}):e.jsx("span",{className:"text-gray-500",children:"price snapshot missing"})]},a.id)})})]})]},s.id)),e.jsx("div",{className:"flex gap-3",children:e.jsx(d,{type:"button",variant:"outline",onClick:y,disabled:q,children:"Refresh"})})]})]})}),e.jsx(T,{value:"payouts",className:"mt-6 space-y-6",children:e.jsxs(u,{className:"shadow-lg",children:[e.jsxs(p,{children:[e.jsx(x,{children:"Manual payouts"}),e.jsx(g,{children:H?"Loading…":`${R.length} shown`})]}),e.jsxs(w,{className:"space-y-4",children:[R.length===0?e.jsx("p",{className:"text-gray-700",children:"No payouts yet."}):null,R.map(s=>e.jsxs("div",{className:"p-4 bg-white border rounded-lg space-y-3",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:justify-between gap-3",children:[e.jsxs("div",{className:"text-sm",children:[e.jsxs("p",{className:"font-semibold text-gray-900",children:["Payout ",e.jsx("code",{className:"break-all",children:s.id})]}),e.jsxs("p",{className:"text-gray-700",children:["Booking: ",e.jsx("code",{className:"break-all",children:s.booking_id})]}),e.jsxs("p",{className:"text-gray-700",children:["Status: ",e.jsx("span",{className:"font-semibold",children:s.status})]}),e.jsxs("p",{className:de(s.eligible_at)?"text-green-700 font-semibold":"text-gray-700",children:["Eligible at: ",s.eligible_at]}),s.paid_at?e.jsxs("p",{className:"text-green-700 font-semibold",children:["Paid at: ",s.paid_at]}):null]}),e.jsxs("div",{className:"text-sm text-gray-800",children:[e.jsxs("p",{children:["Gross: ",e.jsxs("span",{className:"font-semibold",children:["$",h(s.gross_amount)]})]}),e.jsxs("p",{children:["Fee (30%): ",e.jsxs("span",{className:"font-semibold",children:["$",h(s.platform_fee_amount)]})]}),e.jsxs("p",{children:["Net (70%): ",e.jsxs("span",{className:"font-semibold",children:["$",h(s.net_amount)]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"text-sm text-gray-800",children:[e.jsx("p",{className:"font-semibold",children:"Owner payout details"}),e.jsxs("p",{children:["Name: ",s.owner_profiles?.full_name||"—"]}),e.jsxs("p",{children:["Phone: ",s.owner_profiles?.phone||"—"]}),e.jsxs("p",{children:["Bank: ",s.owner_profiles?.bank_name||"—"]}),e.jsxs("p",{children:["Account name: ",s.owner_profiles?.bank_account_name||"—"]}),e.jsxs("p",{children:["Account number: ",s.owner_profiles?.bank_account_number||"—"]}),s.owner_profiles?.bank_branch?e.jsxs("p",{children:["Branch: ",s.owner_profiles.bank_branch]}):null,s.owner_profiles?.payout_notes?e.jsxs("p",{className:"text-gray-600",children:["Notes: ",s.owner_profiles.payout_notes]}):null]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{htmlFor:`payref_${s.id}`,children:"Payment reference (optional)"}),e.jsx(J,{id:`payref_${s.id}`,value:K[s.id]??"",onChange:a=>Q(t=>({...t,[s.id]:a.target.value})),placeholder:"Bank transfer reference"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{type:"button",onClick:()=>ae(s.id),disabled:W===s.id||s.status==="paid",className:"bg-blue-600 hover:bg-blue-700",children:W===s.id?"Saving…":"Mark paid"}),e.jsx(d,{type:"button",variant:"outline",onClick:N,disabled:H,children:"Refresh"})]})]})]})]},s.id))]})]})})]})]})]})};export{pe as default};
