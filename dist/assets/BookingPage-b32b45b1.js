import{h as me,w as ue,i as he,r,j as e,s as F,l as f,I as q,T as ee,B as xe}from"./index-1dfc037b.js";import{P as pe}from"./PageHeader-e0284d83.js";import{C as B,a as I,b as P,e as T,c as W}from"./card-8587318e.js";import{C as se}from"./checkbox-240d4558.js";import{t as be,c as fe,d as ge}from"./differenceInCalendarDays-6447d4da.js";import"./check-61e97ddf.js";function je(p,u,g){const c=be(p,g?.in);return isNaN(u)?fe(g?.in||p,NaN):(u&&c.setDate(c.getDate()+u),c)}const te=p=>{const u=p.getTimezoneOffset()*6e4;return new Date(p.getTime()-u).toISOString().slice(0,10)},ae=p=>{if(!p)return null;const u=new Date(`${p}T00:00:00`);return Number.isNaN(u.getTime())?null:u},ye=p=>p.reduce((u,g)=>{const c=g.category||"other";return u[c]=u[c]||[],u[c].push(g),u},{}),Se=()=>{const p=me(),[u]=ue(),g=(u.get("vehicle")||"").trim(),{toast:c}=he(),[v,ne]=r.useState(()=>te(new Date)),[N,le]=r.useState(()=>te(je(new Date,1))),[_,R]=r.useState([]),[Q,E]=r.useState(!0),[H,$]=r.useState({}),[A,U]=r.useState(!1),[V,L]=r.useState({}),[Y,K]=r.useState(!1),[Z,G]=r.useState(!1),[o,k]=r.useState({full_name:"",phone:"",email:"",address:"",passport_number:"",contact_channels:{whatsapp:!1,zalo:!1,wechat:!1,fb_messenger:!1,none:!0},notes:""}),w=r.useMemo(()=>ae(v),[v]),C=r.useMemo(()=>ae(N),[N]),i=r.useMemo(()=>!w||!C?0:ge(C,w),[w,C]),S=r.useMemo(()=>Object.entries(V).map(([s,a])=>({vehicleId:s,qty:Number(a)||0})).filter(s=>s.qty>0),[V]),J=r.useMemo(()=>S.reduce((s,a)=>s+a.qty,0),[S]),O=r.useMemo(()=>{const s={};for(const a of _)s[a.id]=a;return s},[_]),X=r.useCallback((s,a,t,n)=>{if(!Number.isFinite(s)||s<=0||!Number.isFinite(a))return null;let l=a*s,m="daily";const h=Math.ceil(s/30);for(let d=0;d<=h;d+=1){const x=s-d*30;if(x<0||d>0&&!Number.isFinite(n))continue;const b=Math.ceil(x/7);for(let y=0;y<=b;y+=1){const D=x-y*7;if(D<0||y>0&&!Number.isFinite(t))continue;const M=(d>0&&Number.isFinite(n)?d*n:0)+(y>0&&Number.isFinite(t)?y*t:0)+D*a;(l===null||M<l)&&(l=M,m=d>0?"monthly bundle":y>0?"weekly bundle":"daily")}}return{total:l,label:m}},[]),j=r.useMemo(()=>{if(!i||i<=0)return null;const s=S.map(t=>{const n=O[t.vehicleId]||{},l=Number(n.price_per_day),m=Number(n.price_per_week),h=Number(n.price_per_month),d=Number.isFinite(l)?l*i:null,x=X(i,l,m,h),b=x?x.total:null,y=x?x.label:"daily",D=t.qty,M=d!==null?d*D:null,z=b!==null?b*D:null,oe=M!==null&&z!==null?Math.max(0,M-z):0,de=b!==null?b/i:null;return{vehicleId:t.vehicleId,name:n.name||"Vehicle",qty:D,dayCount:i,baseTotal:d,bestTotal:b,baseWithQty:M,bestWithQty:z,discount:oe,applied:y,effectiveDaily:de,pricePerDay:Number.isFinite(l)?l:null,pricePerWeek:Number.isFinite(m)?m:null,pricePerMonth:Number.isFinite(h)?h:null}}),a=s.reduce((t,n)=>(t.base+=n.baseWithQty??0,t.best+=n.bestWithQty??0,t.discount+=n.discount??0,t),{base:0,best:0,discount:0});return{items:s,totals:a}},[X,i,S,O]),ie=r.useMemo(()=>ye(_),[_]);r.useEffect(()=>{(async()=>{if(!F){E(!1);return}E(!0);const{data:a,error:t}=await F.from("vehicles").select("id, category, name, description, image_url, price_per_day, price_per_week, price_per_month, inventory_count, active, sort_order").eq("active",!0).order("sort_order",{ascending:!0}).order("name",{ascending:!0});t?(c({title:"Could not load vehicles",description:t.message,variant:"destructive"}),R([])):R(a||[]),E(!1)})()},[c]),r.useEffect(()=>{(async()=>{if(!F||!v||!N)return;if(!w||!C||i<=0){$({});return}U(!0);const{data:a,error:t}=await F.rpc("get_vehicle_availability",{p_start_date:v,p_end_date:N});if(t)c({title:"Could not check availability",description:t.message,variant:"destructive"}),$({});else{const n={};for(const l of a||[])n[l.vehicle_id]=l.available_count;$(n),L(l=>{const m={...l};for(const[h,d]of Object.entries(n)){const x=Number(m[h]||0),b=Math.max(0,Math.min(x,Number(d)||0));b!==x&&(m[h]=b)}return m})}U(!1)})()},[i,C,N,w,v,c]),r.useEffect(()=>{if(Z||!g||!_.length)return;const s=_.find(a=>a.name?.toLowerCase().includes(g.toLowerCase()));if(!s){G(!0);return}L(a=>Object.values(a).some(t=>Number(t)>0)?a:{...a,[s.id]:1}),G(!0)},[Z,g,_]);const re=(s,a)=>{const t=Number(H[s]??0),n=Number(a),l=Number.isFinite(n)?n:0,m=Math.max(0,Math.min(l,t));L(h=>({...h,[s]:m}))},ce=async s=>{if(s.preventDefault(),!F){c({title:"Booking is not configured",description:"Supabase credentials are missing.",variant:"destructive"});return}if(!w||!C||i<=0){c({title:"Invalid dates",description:"Please select a start date and an end date (end must be after start).",variant:"destructive"});return}if(!o.full_name.trim()||!o.phone.trim()){c({title:"Missing contact details",description:"Please enter your name and phone number.",variant:"destructive"});return}if(!o.address.trim()){c({title:"Missing address",description:"Please enter your resident or hotel address.",variant:"destructive"});return}if(!o.passport_number.trim()){c({title:"Missing passport number",description:"Please enter your passport number.",variant:"destructive"});return}if(S.length===0){c({title:"No vehicles selected",description:"Please select at least 1 vehicle.",variant:"destructive"});return}const a=S.map(d=>({vehicle_id:d.vehicleId,quantity:d.qty})),t=Object.entries(o.contact_channels).filter(([d,x])=>d!=="none"&&!!x).map(([d])=>d),n={full_name:o.full_name,phone:o.phone,email:o.email,address:o.address,passport_number:o.passport_number,contact_channels:t,contact_channels_none:o.contact_channels.none||t.length===0,notes:o.notes,day_count:i,pricing_summary:j};K(!0);const{data:l,error:m}=await F.rpc("create_booking",{p_start_date:v,p_end_date:N,p_items:a,p_intake:n});if(m){c({title:"Booking failed",description:m.message,variant:"destructive"}),K(!1);return}c({title:"Booking received",description:"We have received your request and will confirm shortly.",className:"bg-blue-500 text-white"}),p(`/book/success/${l}`)};return e.jsxs("div",{className:"bg-gray-50",children:[e.jsx(pe,{title:"Book a Motorbike or Car",subtitle:"Select dates, choose your vehicles, and send your booking request.",breadcrumbs:[{name:"Home",link:"/"},{name:"Book"}]}),e.jsxs("main",{className:"container mx-auto px-4 py-12",children:[!F&&e.jsx(B,{className:"shadow-lg",children:e.jsxs(I,{children:[e.jsx(P,{children:"Booking is not available"}),e.jsxs(T,{children:["Supabase is not configured. Set ",e.jsx("code",{children:"VITE_SUPABASE_URL"})," and ",e.jsx("code",{children:"VITE_SUPABASE_ANON_KEY"}),"."]})]})}),F&&e.jsx("div",{className:"space-y-6",children:e.jsxs("form",{onSubmit:ce,className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs(B,{className:"shadow-lg",children:[e.jsxs(I,{children:[e.jsx(P,{children:"1) Choose your dates"}),e.jsx(T,{children:"Dates are treated as: pickup on start date, return on end date."})]}),e.jsxs(W,{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(f,{htmlFor:"start_date",children:"Start date"}),e.jsx(q,{id:"start_date",type:"date",value:v,onChange:s=>ne(s.target.value),required:!0})]}),e.jsxs("div",{children:[e.jsx(f,{htmlFor:"end_date",children:"End date"}),e.jsx(q,{id:"end_date",type:"date",value:N,onChange:s=>le(s.target.value),required:!0})]}),e.jsx("div",{className:"sm:col-span-2 text-sm text-gray-700",children:i>0?e.jsxs("span",{children:["Rental duration: ",e.jsx("span",{className:"font-semibold",children:i})," day",i===1?"":"s"]}):e.jsx("span",{className:"text-red-600",children:"Please select a valid date range (end date must be after start date)."})})]})]}),e.jsxs(B,{className:"shadow-lg",children:[e.jsxs(I,{children:[e.jsx(P,{children:"2) Select vehicles"}),e.jsx(T,{children:Q?"Loading vehicles…":A?"Checking availability…":"Choose quantities (limited by availability)."})]}),e.jsxs(W,{className:"space-y-8",children:[!Q&&_.length===0&&e.jsxs("p",{className:"text-gray-700",children:["No vehicles found. Add records to the ",e.jsx("code",{children:"vehicles"})," table."]}),Object.entries(ie).map(([s,a])=>e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 capitalize",children:s}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:a.map(t=>{const n=Number(H[t.id]??0),l=Number(V[t.id]??0),m=!w||!C||i<=0||A;return e.jsx(B,{className:"border border-gray-200",children:e.jsxs(W,{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start gap-4",children:[t.image_url?e.jsx("img",{src:t.image_url,alt:t.name,className:"h-16 w-24 object-cover rounded-md border",loading:"lazy"}):e.jsx("div",{className:"h-16 w-24 rounded-md border bg-gray-100"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("p",{className:"font-semibold text-gray-900",children:t.name}),typeof t.price_per_day=="number"||t.price_per_day?e.jsxs("p",{className:"text-sm text-gray-700",children:["$",Number(t.price_per_day),"/day"]}):null]}),t.description?e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:t.description}):null]})]}),e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Available: "}),e.jsx("span",{className:n>0?"font-semibold text-green-700":"font-semibold text-gray-700",children:A||!w||!C||i<=0?"—":n})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(f,{htmlFor:`qty_${t.id}`,className:"text-sm text-gray-700",children:"Qty"}),e.jsx(q,{id:`qty_${t.id}`,type:"number",min:0,max:n,value:l,disabled:m,onChange:h=>re(t.id,h.target.value),className:"w-24"})]})]})]})},t.id)})})]},s))]})]}),e.jsxs(B,{className:"shadow-lg",children:[e.jsxs(I,{children:[e.jsx(P,{children:"3) Your details"}),e.jsx(T,{children:"We’ll contact you to confirm. Payment is cash on arrival."})]}),e.jsxs(W,{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(f,{htmlFor:"full_name",children:"Full name"}),e.jsx(q,{id:"full_name",value:o.full_name,onChange:s=>k(a=>({...a,full_name:s.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx(f,{htmlFor:"phone",children:"Phone number"}),e.jsx(q,{id:"phone",value:o.phone,onChange:s=>k(a=>({...a,phone:s.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx(f,{htmlFor:"email",children:"Email (optional)"}),e.jsx(q,{id:"email",type:"email",value:o.email,onChange:s=>k(a=>({...a,email:s.target.value}))})]}),e.jsxs("div",{children:[e.jsx(f,{htmlFor:"passport_number",children:"Passport number"}),e.jsx(q,{id:"passport_number",value:o.passport_number,onChange:s=>k(a=>({...a,passport_number:s.target.value})),required:!0})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(f,{htmlFor:"address",children:"Resident or hotel address"}),e.jsx(ee,{id:"address",value:o.address,onChange:s=>k(a=>({...a,address:s.target.value})),placeholder:"Hotel name + room, or full address",required:!0})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(f,{children:"Contact apps (optional)"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Select any you use, or choose “None of these”."}),e.jsxs("div",{className:"mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3",children:[[{key:"whatsapp",label:"WhatsApp"},{key:"zalo",label:"Zalo"},{key:"wechat",label:"WeChat"},{key:"fb_messenger",label:"Facebook Messenger"}].map(s=>e.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-800",children:[e.jsx(se,{checked:!!o.contact_channels[s.key],onCheckedChange:a=>{const t=a===!0;k(n=>{const l={...n,contact_channels:{...n.contact_channels}};return l.contact_channels[s.key]=t,t&&(l.contact_channels.none=!1),l})}}),s.label]},s.key)),e.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-800",children:[e.jsx(se,{checked:!!o.contact_channels.none,onCheckedChange:s=>{const a=s===!0;k(t=>a?{...t,contact_channels:{whatsapp:!1,zalo:!1,wechat:!1,fb_messenger:!1,none:!0}}:{...t,contact_channels:{...t.contact_channels,none:!1}})}}),"None of these"]})]})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(f,{htmlFor:"notes",children:"Notes (optional)"}),e.jsx(ee,{id:"notes",value:o.notes,onChange:s=>k(a=>({...a,notes:s.target.value})),placeholder:"Pickup details, license info, delivery request, etc."})]})]})]})]}),e.jsx("div",{className:"space-y-6",children:e.jsxs(B,{className:"shadow-lg",children:[e.jsxs(I,{children:[e.jsx(P,{children:"Summary"}),e.jsx(T,{children:"Review before submitting."})]}),e.jsxs(W,{className:"space-y-3",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Dates"}),e.jsxs("span",{className:"font-medium",children:[v," → ",N]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Duration"}),e.jsx("span",{className:"font-medium",children:i>0?`${i} day${i===1?"":"s"}`:"—"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Total vehicles"}),e.jsx("span",{className:"font-medium",children:J})]})]}),e.jsx("div",{className:"border-t pt-3",children:S.length===0?e.jsx("p",{className:"text-sm text-gray-600",children:"No vehicles selected yet."}):e.jsx("ul",{className:"space-y-3",children:(j?.items?.length?j.items:S.map(s=>({vehicleId:s.vehicleId,name:O[s.vehicleId]?.name||"Vehicle",qty:s.qty,baseWithQty:null,bestWithQty:null,discount:0,applied:""}))).map(s=>e.jsxs("li",{className:"text-sm border rounded-lg p-3 bg-white",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"text-gray-900 font-medium",children:s.name}),e.jsxs("span",{className:"font-semibold",children:["× ",s.qty]})]}),e.jsxs("div",{className:"mt-2 text-gray-700 space-y-1",children:[s.baseWithQty!==null?e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Standard"}),e.jsxs("span",{className:"line-through text-gray-500",children:["$",s.baseWithQty.toFixed(2)]})]}):null,s.bestWithQty!==null?e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("span",{className:"font-semibold text-gray-800",children:["Best rate (",s.applied,")"]}),e.jsxs("span",{className:"font-semibold text-emerald-700",children:["$",s.bestWithQty.toFixed(2)]})]}):null,s.discount>0?e.jsxs("div",{className:"flex justify-between items-center text-amber-800 font-semibold",children:[e.jsx("span",{children:"Lucky Day Bonus"}),e.jsxs("span",{children:["- $",s.discount.toFixed(2)]})]}):null]})]},s.vehicleId))})}),j&&j.items.length>0?e.jsxs("div",{className:"mt-4 space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-700",children:"Subtotal"}),e.jsxs("span",{className:"font-semibold text-gray-900",children:["$",j.totals.base.toFixed(2)]})]}),j.totals.discount>0?e.jsxs("div",{className:"flex justify-between items-center rounded-lg border border-amber-400 bg-amber-50 px-3 py-2 text-amber-900 font-semibold",children:[e.jsx("span",{children:"Lucky Day Bonus"}),e.jsxs("span",{children:["- $",j.totals.discount.toFixed(2)]})]}):null,e.jsxs("div",{className:"flex justify-between text-lg font-bold text-emerald-700",children:[e.jsxs("span",{children:["Total for ",i," day",i===1?"":"s"]}),e.jsxs("span",{children:["$",j.totals.best.toFixed(2)]})]})]}):null]}),e.jsxs("div",{className:"p-6 pt-0",children:[e.jsx(xe,{type:"submit",disabled:Y||Q||A||i<=0||J<=0,className:"w-full bg-blue-600 hover:bg-blue-700",children:Y?"Submitting…":"Submit booking request"}),e.jsx("p",{className:"text-xs text-gray-500 mt-3",children:"By submitting, you agree we can contact you to confirm availability."})]})]})})]})})]})]})};export{Se as default};
