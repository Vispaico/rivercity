import{h as de,w as oe,i as me,r,j as e,s as C,l as b,I as S,T as J,B as ue}from"./index-ff5f5ba8.js";import{P as he}from"./PageHeader-27ee59ae.js";import{C as F,a as D,b as P,e as I,c as B}from"./card-86508010.js";import{C as X}from"./checkbox-42e675e0.js";import{t as xe,c as pe,d as be}from"./differenceInCalendarDays-6447d4da.js";import"./check-c12b2808.js";function fe(p,u,f){const l=xe(p,f?.in);return isNaN(u)?pe(f?.in||p,NaN):(u&&l.setDate(l.getDate()+u),l)}const ee=p=>{const u=p.getTimezoneOffset()*6e4;return new Date(p.getTime()-u).toISOString().slice(0,10)},se=p=>{if(!p)return null;const u=new Date(`${p}T00:00:00`);return Number.isNaN(u.getTime())?null:u},ge=p=>p.reduce((u,f)=>{const l=f.category||"other";return u[l]=u[l]||[],u[l].push(f),u},{}),ke=()=>{const p=de(),[u]=oe(),f=(u.get("vehicle")||"").trim(),{toast:l}=me(),[y,te]=r.useState(()=>ee(new Date)),[j,ae]=r.useState(()=>ee(fe(new Date,1))),[v,z]=r.useState([]),[A,Q]=r.useState(!0),[R,W]=r.useState({}),[M,H]=r.useState(!1),[T,E]=r.useState({}),[U,Y]=r.useState(!1),[K,Z]=r.useState(!1),[c,N]=r.useState({full_name:"",phone:"",email:"",address:"",passport_number:"",contact_channels:{whatsapp:!1,zalo:!1,wechat:!1,fb_messenger:!1,none:!0},notes:""}),_=r.useMemo(()=>se(y),[y]),w=r.useMemo(()=>se(j),[j]),i=r.useMemo(()=>!_||!w?0:be(w,_),[_,w]),k=r.useMemo(()=>Object.entries(T).map(([s,a])=>({vehicleId:s,qty:Number(a)||0})).filter(s=>s.qty>0),[T]),G=r.useMemo(()=>k.reduce((s,a)=>s+a.qty,0),[k]),$=r.useMemo(()=>{const s={};for(const a of v)s[a.id]=a;return s},[v]),g=r.useMemo(()=>{if(!i||i<=0)return null;const s=k.map(t=>{const n=$[t.vehicleId]||{},d=Number(n.price_per_day),o=Number(n.price_per_week),h=Number(n.price_per_month),x=Number.isFinite(d)?d*i:null;let m=x,q="daily";Number.isFinite(o)&&(m===null||o<m)&&(m=o,q="weekly"),Number.isFinite(h)&&(m===null||h<m)&&(m=h,q="monthly");const re=m!==null?m/i:null,V=t.qty,L=x!==null?x*V:null,O=m!==null?m*V:null,ce=L!==null&&O!==null?Math.max(0,L-O):0;return{vehicleId:t.vehicleId,name:n.name||"Vehicle",qty:V,dayCount:i,baseTotal:x,bestTotal:m,baseWithQty:L,bestWithQty:O,discount:ce,applied:q,effectiveDaily:re,pricePerDay:Number.isFinite(d)?d:null,pricePerWeek:Number.isFinite(o)?o:null,pricePerMonth:Number.isFinite(h)?h:null}}),a=s.reduce((t,n)=>(t.base+=n.baseWithQty??0,t.best+=n.bestWithQty??0,t.discount+=n.discount??0,t),{base:0,best:0,discount:0});return{items:s,totals:a}},[i,k,$]),ne=r.useMemo(()=>ge(v),[v]);r.useEffect(()=>{(async()=>{if(!C){Q(!1);return}Q(!0);const{data:a,error:t}=await C.from("vehicles").select("id, category, name, description, image_url, price_per_day, price_per_week, price_per_month, inventory_count, active, sort_order").eq("active",!0).order("sort_order",{ascending:!0}).order("name",{ascending:!0});t?(l({title:"Could not load vehicles",description:t.message,variant:"destructive"}),z([])):z(a||[]),Q(!1)})()},[l]),r.useEffect(()=>{(async()=>{if(!C||!y||!j)return;if(!_||!w||i<=0){W({});return}H(!0);const{data:a,error:t}=await C.rpc("get_vehicle_availability",{p_start_date:y,p_end_date:j});if(t)l({title:"Could not check availability",description:t.message,variant:"destructive"}),W({});else{const n={};for(const d of a||[])n[d.vehicle_id]=d.available_count;W(n),E(d=>{const o={...d};for(const[h,x]of Object.entries(n)){const m=Number(o[h]||0),q=Math.max(0,Math.min(m,Number(x)||0));q!==m&&(o[h]=q)}return o})}H(!1)})()},[i,w,j,_,y,l]),r.useEffect(()=>{if(K||!f||!v.length)return;const s=v.find(a=>a.name?.toLowerCase().includes(f.toLowerCase()));if(!s){Z(!0);return}E(a=>Object.values(a).some(t=>Number(t)>0)?a:{...a,[s.id]:1}),Z(!0)},[K,f,v]);const le=(s,a)=>{const t=Number(R[s]??0),n=Number(a),d=Number.isFinite(n)?n:0,o=Math.max(0,Math.min(d,t));E(h=>({...h,[s]:o}))},ie=async s=>{if(s.preventDefault(),!C){l({title:"Booking is not configured",description:"Supabase credentials are missing.",variant:"destructive"});return}if(!_||!w||i<=0){l({title:"Invalid dates",description:"Please select a start date and an end date (end must be after start).",variant:"destructive"});return}if(!c.full_name.trim()||!c.phone.trim()){l({title:"Missing contact details",description:"Please enter your name and phone number.",variant:"destructive"});return}if(!c.address.trim()){l({title:"Missing address",description:"Please enter your resident or hotel address.",variant:"destructive"});return}if(!c.passport_number.trim()){l({title:"Missing passport number",description:"Please enter your passport number.",variant:"destructive"});return}if(k.length===0){l({title:"No vehicles selected",description:"Please select at least 1 vehicle.",variant:"destructive"});return}const a=k.map(x=>({vehicle_id:x.vehicleId,quantity:x.qty})),t=Object.entries(c.contact_channels).filter(([x,m])=>x!=="none"&&!!m).map(([x])=>x),n={full_name:c.full_name,phone:c.phone,email:c.email,address:c.address,passport_number:c.passport_number,contact_channels:t,contact_channels_none:c.contact_channels.none||t.length===0,notes:c.notes,day_count:i,pricing_summary:g};Y(!0);const{data:d,error:o}=await C.rpc("create_booking",{p_start_date:y,p_end_date:j,p_items:a,p_intake:n});if(o){l({title:"Booking failed",description:o.message,variant:"destructive"}),Y(!1);return}l({title:"Booking received",description:"We have received your request and will confirm shortly.",className:"bg-blue-500 text-white"}),p(`/book/success/${d}`)};return e.jsxs("div",{className:"bg-gray-50",children:[e.jsx(he,{title:"Book a Motorbike or Car",subtitle:"Select dates, choose your vehicles, and send your booking request.",breadcrumbs:[{name:"Home",link:"/"},{name:"Book"}]}),e.jsxs("main",{className:"container mx-auto px-4 py-12",children:[!C&&e.jsx(F,{className:"shadow-lg",children:e.jsxs(D,{children:[e.jsx(P,{children:"Booking is not available"}),e.jsxs(I,{children:["Supabase is not configured. Set ",e.jsx("code",{children:"VITE_SUPABASE_URL"})," and ",e.jsx("code",{children:"VITE_SUPABASE_ANON_KEY"}),"."]})]})}),C&&e.jsx("div",{className:"space-y-6",children:e.jsxs("form",{onSubmit:ie,className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs(F,{className:"shadow-lg",children:[e.jsxs(D,{children:[e.jsx(P,{children:"1) Choose your dates"}),e.jsx(I,{children:"Dates are treated as: pickup on start date, return on end date."})]}),e.jsxs(B,{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(b,{htmlFor:"start_date",children:"Start date"}),e.jsx(S,{id:"start_date",type:"date",value:y,onChange:s=>te(s.target.value),required:!0})]}),e.jsxs("div",{children:[e.jsx(b,{htmlFor:"end_date",children:"End date"}),e.jsx(S,{id:"end_date",type:"date",value:j,onChange:s=>ae(s.target.value),required:!0})]}),e.jsx("div",{className:"sm:col-span-2 text-sm text-gray-700",children:i>0?e.jsxs("span",{children:["Rental duration: ",e.jsx("span",{className:"font-semibold",children:i})," day",i===1?"":"s"]}):e.jsx("span",{className:"text-red-600",children:"Please select a valid date range (end date must be after start date)."})})]})]}),e.jsxs(F,{className:"shadow-lg",children:[e.jsxs(D,{children:[e.jsx(P,{children:"2) Select vehicles"}),e.jsx(I,{children:A?"Loading vehicles…":M?"Checking availability…":"Choose quantities (limited by availability)."})]}),e.jsxs(B,{className:"space-y-8",children:[!A&&v.length===0&&e.jsxs("p",{className:"text-gray-700",children:["No vehicles found. Add records to the ",e.jsx("code",{children:"vehicles"})," table."]}),Object.entries(ne).map(([s,a])=>e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 capitalize",children:s}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:a.map(t=>{const n=Number(R[t.id]??0),d=Number(T[t.id]??0),o=!_||!w||i<=0||M;return e.jsx(F,{className:"border border-gray-200",children:e.jsxs(B,{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start gap-4",children:[t.image_url?e.jsx("img",{src:t.image_url,alt:t.name,className:"h-16 w-24 object-cover rounded-md border",loading:"lazy"}):e.jsx("div",{className:"h-16 w-24 rounded-md border bg-gray-100"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("p",{className:"font-semibold text-gray-900",children:t.name}),typeof t.price_per_day=="number"||t.price_per_day?e.jsxs("p",{className:"text-sm text-gray-700",children:["$",Number(t.price_per_day),"/day"]}):null]}),t.description?e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:t.description}):null]})]}),e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Available: "}),e.jsx("span",{className:n>0?"font-semibold text-green-700":"font-semibold text-gray-700",children:M||!_||!w||i<=0?"—":n})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(b,{htmlFor:`qty_${t.id}`,className:"text-sm text-gray-700",children:"Qty"}),e.jsx(S,{id:`qty_${t.id}`,type:"number",min:0,max:n,value:d,disabled:o,onChange:h=>le(t.id,h.target.value),className:"w-24"})]})]})]})},t.id)})})]},s))]})]}),e.jsxs(F,{className:"shadow-lg",children:[e.jsxs(D,{children:[e.jsx(P,{children:"3) Your details"}),e.jsx(I,{children:"We’ll contact you to confirm. Payment is cash on arrival."})]}),e.jsxs(B,{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(b,{htmlFor:"full_name",children:"Full name"}),e.jsx(S,{id:"full_name",value:c.full_name,onChange:s=>N(a=>({...a,full_name:s.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx(b,{htmlFor:"phone",children:"Phone number"}),e.jsx(S,{id:"phone",value:c.phone,onChange:s=>N(a=>({...a,phone:s.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx(b,{htmlFor:"email",children:"Email (optional)"}),e.jsx(S,{id:"email",type:"email",value:c.email,onChange:s=>N(a=>({...a,email:s.target.value}))})]}),e.jsxs("div",{children:[e.jsx(b,{htmlFor:"passport_number",children:"Passport number"}),e.jsx(S,{id:"passport_number",value:c.passport_number,onChange:s=>N(a=>({...a,passport_number:s.target.value})),required:!0})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(b,{htmlFor:"address",children:"Resident or hotel address"}),e.jsx(J,{id:"address",value:c.address,onChange:s=>N(a=>({...a,address:s.target.value})),placeholder:"Hotel name + room, or full address",required:!0})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(b,{children:"Contact apps (optional)"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Select any you use, or choose “None of these”."}),e.jsxs("div",{className:"mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3",children:[[{key:"whatsapp",label:"WhatsApp"},{key:"zalo",label:"Zalo"},{key:"wechat",label:"WeChat"},{key:"fb_messenger",label:"Facebook Messenger"}].map(s=>e.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-800",children:[e.jsx(X,{checked:!!c.contact_channels[s.key],onCheckedChange:a=>{const t=a===!0;N(n=>{const d={...n,contact_channels:{...n.contact_channels}};return d.contact_channels[s.key]=t,t&&(d.contact_channels.none=!1),d})}}),s.label]},s.key)),e.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-800",children:[e.jsx(X,{checked:!!c.contact_channels.none,onCheckedChange:s=>{const a=s===!0;N(t=>a?{...t,contact_channels:{whatsapp:!1,zalo:!1,wechat:!1,fb_messenger:!1,none:!0}}:{...t,contact_channels:{...t.contact_channels,none:!1}})}}),"None of these"]})]})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(b,{htmlFor:"notes",children:"Notes (optional)"}),e.jsx(J,{id:"notes",value:c.notes,onChange:s=>N(a=>({...a,notes:s.target.value})),placeholder:"Pickup details, license info, delivery request, etc."})]})]})]})]}),e.jsx("div",{className:"space-y-6",children:e.jsxs(F,{className:"shadow-lg",children:[e.jsxs(D,{children:[e.jsx(P,{children:"Summary"}),e.jsx(I,{children:"Review before submitting."})]}),e.jsxs(B,{className:"space-y-3",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Dates"}),e.jsxs("span",{className:"font-medium",children:[y," → ",j]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Duration"}),e.jsx("span",{className:"font-medium",children:i>0?`${i} day${i===1?"":"s"}`:"—"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Total vehicles"}),e.jsx("span",{className:"font-medium",children:G})]})]}),e.jsx("div",{className:"border-t pt-3",children:k.length===0?e.jsx("p",{className:"text-sm text-gray-600",children:"No vehicles selected yet."}):e.jsx("ul",{className:"space-y-3",children:(g?.items?.length?g.items:k.map(s=>({vehicleId:s.vehicleId,name:$[s.vehicleId]?.name||"Vehicle",qty:s.qty,baseWithQty:null,bestWithQty:null,discount:0,applied:""}))).map(s=>e.jsxs("li",{className:"text-sm border rounded-lg p-3 bg-white",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"text-gray-900 font-medium",children:s.name}),e.jsxs("span",{className:"font-semibold",children:["× ",s.qty]})]}),e.jsxs("div",{className:"mt-2 text-gray-700 space-y-1",children:[s.baseWithQty!==null?e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Standard"}),e.jsxs("span",{className:"line-through text-gray-500",children:["$",s.baseWithQty.toFixed(2)]})]}):null,s.bestWithQty!==null?e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("span",{className:"font-semibold text-gray-800",children:["Best rate (",s.applied,")"]}),e.jsxs("span",{className:"font-semibold text-emerald-700",children:["$",s.bestWithQty.toFixed(2)]})]}):null,s.discount>0?e.jsxs("div",{className:"flex justify-between items-center text-amber-800 font-semibold",children:[e.jsx("span",{children:"Lucky Day Bonus"}),e.jsxs("span",{children:["- $",s.discount.toFixed(2)]})]}):null]})]},s.vehicleId))})}),g&&g.items.length>0?e.jsxs("div",{className:"mt-4 space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-700",children:"Subtotal"}),e.jsxs("span",{className:"font-semibold text-gray-900",children:["$",g.totals.base.toFixed(2)]})]}),g.totals.discount>0?e.jsxs("div",{className:"flex justify-between items-center rounded-lg border border-amber-400 bg-amber-50 px-3 py-2 text-amber-900 font-semibold",children:[e.jsx("span",{children:"Lucky Day Bonus"}),e.jsxs("span",{children:["- $",g.totals.discount.toFixed(2)]})]}):null,e.jsxs("div",{className:"flex justify-between text-lg font-bold text-emerald-700",children:[e.jsxs("span",{children:["Total for ",i," day",i===1?"":"s"]}),e.jsxs("span",{children:["$",g.totals.best.toFixed(2)]})]})]}):null]}),e.jsxs("div",{className:"p-6 pt-0",children:[e.jsx(ue,{type:"submit",disabled:U||A||M||i<=0||G<=0,className:"w-full bg-blue-600 hover:bg-blue-700",children:U?"Submitting…":"Submit booking request"}),e.jsx("p",{className:"text-xs text-gray-500 mt-3",children:"By submitting, you agree we can contact you to confirm availability."})]})]})})]})})]})]})};export{ke as default};
