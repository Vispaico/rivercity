import{o as me,y as ue,k as he,r,j as e,q as N,I as _,B as ee}from"./index-80ac856c.js";import{P as pe}from"./PageHeader-0a5c0ed7.js";import{C as k,a as S,b as q,e as P,c as I}from"./card-b8ee0251.js";import{L as u}from"./label-d30f68fa.js";import{T as O}from"./textarea-df67c958.js";import{C as se}from"./checkbox-4a889a5c.js";import{t as xe,c as ge,d as fe}from"./differenceInCalendarDays-6447d4da.js";import"./check-be37ca78.js";function ye(o,d,p){const n=xe(o,p?.in);return isNaN(d)?ge(p?.in||o,NaN):(d&&n.setDate(n.getDate()+d),n)}const te=o=>{const d=o.getTimezoneOffset()*6e4;return new Date(o.getTime()-d).toISOString().slice(0,10)},ae=o=>{if(!o)return null;const d=new Date(`${o}T00:00:00`);return Number.isNaN(d.getTime())?null:d},je=o=>o.reduce((d,p)=>{const n=p.category||"other";return d[n]=d[n]||[],d[n].push(p),d},{}),qe=()=>{const o=me(),[d]=ue(),p=(d.get("vehicle")||"").trim(),{toast:n}=he(),[x,ne]=r.useState(()=>te(new Date)),[g,re]=r.useState(()=>te(ye(new Date,1))),[f,V]=r.useState([]),[E,B]=r.useState(!0),[L,A]=r.useState({}),[D,z]=r.useState(!1),[F,T]=r.useState({}),[$,Q]=r.useState(!1),[R,W]=r.useState(!1),[i,y]=r.useState({full_name:"",phone:"",email:"",address:"",passport_number:"",contact_channels:{whatsapp:!1,zalo:!1,wechat:!1,fb_messenger:!1,none:!0},notes:""}),[H,U]=r.useState(""),[J,Y]=r.useState(""),[Z,K]=r.useState(!1),j=r.useMemo(()=>ae(x),[x]),b=r.useMemo(()=>ae(g),[g]),m=r.useMemo(()=>!j||!b?0:fe(b,j),[j,b]),C=r.useMemo(()=>Object.entries(F).map(([s,t])=>({vehicleId:s,qty:Number(t)||0})).filter(s=>s.qty>0),[F]),G=r.useMemo(()=>C.reduce((s,t)=>s+t.qty,0),[C]),ie=r.useMemo(()=>{const s={};for(const t of f)s[t.id]=t;return s},[f]),le=r.useMemo(()=>je(f),[f]),ce=async s=>{s.preventDefault();const t=H.trim(),a=J.trim();if(!t){n({title:"Email required",description:"Please enter your email address so we can reply.",variant:"destructive"});return}if(!/.+@.+\..+/.test(t)){n({title:"Invalid email",description:"Please enter a valid email address.",variant:"destructive"});return}if(!a){n({title:"Message required",description:"Please type a short message so we know how to help.",variant:"destructive"});return}K(!0);try{const l=await fetch("/api/inquiry",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,message:a,source:"booking_page"})});if(!l.ok){const c=await l.json().catch(()=>null);throw new Error(c?.error||"Failed to send.")}n({title:"Message sent",description:"Thanks — we’ll reply to your email shortly.",className:"bg-blue-500 text-white"}),U(""),Y("")}catch(l){n({title:"Could not send message",description:l?.message||"Please try again, or use WhatsApp/Zalo.",variant:"destructive"})}finally{K(!1)}};r.useEffect(()=>{(async()=>{if(!N){B(!1);return}B(!0);const{data:t,error:a}=await N.from("vehicles").select("id, category, name, description, image_url, price_per_day, inventory_count, active, sort_order").eq("active",!0).order("sort_order",{ascending:!0}).order("name",{ascending:!0});a?(n({title:"Could not load vehicles",description:a.message,variant:"destructive"}),V([])):V(t||[]),B(!1)})()},[n]),r.useEffect(()=>{(async()=>{if(!N||!x||!g)return;if(!j||!b||m<=0){A({});return}z(!0);const{data:t,error:a}=await N.rpc("get_vehicle_availability",{p_start_date:x,p_end_date:g});if(a)n({title:"Could not check availability",description:a.message,variant:"destructive"}),A({});else{const l={};for(const c of t||[])l[c.vehicle_id]=c.available_count;A(l),T(c=>{const h={...c};for(const[w,v]of Object.entries(l)){const M=Number(h[w]||0),X=Math.max(0,Math.min(M,Number(v)||0));X!==M&&(h[w]=X)}return h})}z(!1)})()},[m,b,g,j,x,n]),r.useEffect(()=>{if(R||!p||!f.length)return;const s=f.find(t=>t.name?.toLowerCase().includes(p.toLowerCase()));if(!s){W(!0);return}T(t=>Object.values(t).some(a=>Number(a)>0)?t:{...t,[s.id]:1}),W(!0)},[R,p,f]);const de=(s,t)=>{const a=Number(L[s]??0),l=Number(t),c=Number.isFinite(l)?l:0,h=Math.max(0,Math.min(c,a));T(w=>({...w,[s]:h}))},oe=async s=>{if(s.preventDefault(),!N){n({title:"Booking is not configured",description:"Supabase credentials are missing.",variant:"destructive"});return}if(!j||!b||m<=0){n({title:"Invalid dates",description:"Please select a start date and an end date (end must be after start).",variant:"destructive"});return}if(!i.full_name.trim()||!i.phone.trim()){n({title:"Missing contact details",description:"Please enter your name and phone number.",variant:"destructive"});return}if(!i.address.trim()){n({title:"Missing address",description:"Please enter your resident or hotel address.",variant:"destructive"});return}if(!i.passport_number.trim()){n({title:"Missing passport number",description:"Please enter your passport number.",variant:"destructive"});return}if(C.length===0){n({title:"No vehicles selected",description:"Please select at least 1 vehicle.",variant:"destructive"});return}const t=C.map(v=>({vehicle_id:v.vehicleId,quantity:v.qty})),a=Object.entries(i.contact_channels).filter(([v,M])=>v!=="none"&&!!M).map(([v])=>v),l={full_name:i.full_name,phone:i.phone,email:i.email,address:i.address,passport_number:i.passport_number,contact_channels:a,contact_channels_none:i.contact_channels.none||a.length===0,notes:i.notes};Q(!0);const{data:c,error:h}=await N.rpc("create_booking",{p_start_date:x,p_end_date:g,p_items:t,p_intake:l});if(h){n({title:"Booking failed",description:h.message,variant:"destructive"}),Q(!1);return}n({title:"Booking received",description:"We have received your request and will confirm shortly.",className:"bg-blue-500 text-white"}),o(`/book/success/${c}`)};return e.jsxs("div",{className:"bg-gray-50",children:[e.jsx(pe,{title:"Book a Motorbike or Car",subtitle:"Select dates, choose your vehicles, and send your booking request.",breadcrumbs:[{name:"Home",link:"/"},{name:"Book"}]}),e.jsxs("main",{className:"container mx-auto px-4 py-12",children:[!N&&e.jsx(k,{className:"shadow-lg",children:e.jsxs(S,{children:[e.jsx(q,{children:"Booking is not available"}),e.jsxs(P,{children:["Supabase is not configured. Set ",e.jsx("code",{children:"VITE_SUPABASE_URL"})," and ",e.jsx("code",{children:"VITE_SUPABASE_ANON_KEY"}),"."]})]})}),N&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs(k,{className:"shadow-lg",children:[e.jsxs(S,{children:[e.jsx(q,{children:"Quick inquiry"}),e.jsx(P,{children:"Just have a question? Send us a message and we’ll reply by email."})]}),e.jsx(I,{children:e.jsxs("form",{onSubmit:ce,className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(u,{htmlFor:"inquiry_email",children:"Email"}),e.jsx(_,{id:"inquiry_email",type:"email",value:H,onChange:s=>U(s.target.value),placeholder:"you@example.com",required:!0})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(u,{htmlFor:"inquiry_message",children:"Message"}),e.jsx(O,{id:"inquiry_message",value:J,onChange:s=>Y(s.target.value),placeholder:"Tell us what you need (dates, vehicle type, pickup location, etc.)",required:!0})]}),e.jsx("div",{className:"md:col-span-2 flex justify-end",children:e.jsx(ee,{type:"submit",disabled:Z,className:"bg-blue-600 hover:bg-blue-700",children:Z?"Sending…":"Send message"})})]})})]}),e.jsxs("form",{onSubmit:oe,className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs(k,{className:"shadow-lg",children:[e.jsxs(S,{children:[e.jsx(q,{children:"1) Choose your dates"}),e.jsx(P,{children:"Dates are treated as: pickup on start date, return on end date."})]}),e.jsxs(I,{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(u,{htmlFor:"start_date",children:"Start date"}),e.jsx(_,{id:"start_date",type:"date",value:x,onChange:s=>ne(s.target.value),required:!0})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"end_date",children:"End date"}),e.jsx(_,{id:"end_date",type:"date",value:g,onChange:s=>re(s.target.value),required:!0})]}),e.jsx("div",{className:"sm:col-span-2 text-sm text-gray-700",children:m>0?e.jsxs("span",{children:["Rental duration: ",e.jsx("span",{className:"font-semibold",children:m})," day",m===1?"":"s"]}):e.jsx("span",{className:"text-red-600",children:"Please select a valid date range (end date must be after start date)."})})]})]}),e.jsxs(k,{className:"shadow-lg",children:[e.jsxs(S,{children:[e.jsx(q,{children:"2) Select vehicles"}),e.jsx(P,{children:E?"Loading vehicles…":D?"Checking availability…":"Choose quantities (limited by availability)."})]}),e.jsxs(I,{className:"space-y-8",children:[!E&&f.length===0&&e.jsxs("p",{className:"text-gray-700",children:["No vehicles found. Add records to the ",e.jsx("code",{children:"vehicles"})," table."]}),Object.entries(le).map(([s,t])=>e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 capitalize",children:s}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:t.map(a=>{const l=Number(L[a.id]??0),c=Number(F[a.id]??0),h=!j||!b||m<=0||D;return e.jsx(k,{className:"border border-gray-200",children:e.jsxs(I,{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start gap-4",children:[a.image_url?e.jsx("img",{src:a.image_url,alt:a.name,className:"h-16 w-24 object-cover rounded-md border",loading:"lazy"}):e.jsx("div",{className:"h-16 w-24 rounded-md border bg-gray-100"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("p",{className:"font-semibold text-gray-900",children:a.name}),typeof a.price_per_day=="number"||a.price_per_day?e.jsxs("p",{className:"text-sm text-gray-700",children:["$",Number(a.price_per_day),"/day"]}):null]}),a.description?e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:a.description}):null]})]}),e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Available: "}),e.jsx("span",{className:l>0?"font-semibold text-green-700":"font-semibold text-gray-700",children:D||!j||!b||m<=0?"—":l})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(u,{htmlFor:`qty_${a.id}`,className:"text-sm text-gray-700",children:"Qty"}),e.jsx(_,{id:`qty_${a.id}`,type:"number",min:0,max:l,value:c,disabled:h,onChange:w=>de(a.id,w.target.value),className:"w-24"})]})]})]})},a.id)})})]},s))]})]}),e.jsxs(k,{className:"shadow-lg",children:[e.jsxs(S,{children:[e.jsx(q,{children:"3) Your details"}),e.jsx(P,{children:"We’ll contact you to confirm. Payment is cash on arrival."})]}),e.jsxs(I,{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(u,{htmlFor:"full_name",children:"Full name"}),e.jsx(_,{id:"full_name",value:i.full_name,onChange:s=>y(t=>({...t,full_name:s.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"phone",children:"Phone number"}),e.jsx(_,{id:"phone",value:i.phone,onChange:s=>y(t=>({...t,phone:s.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"email",children:"Email (optional)"}),e.jsx(_,{id:"email",type:"email",value:i.email,onChange:s=>y(t=>({...t,email:s.target.value}))})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"passport_number",children:"Passport number"}),e.jsx(_,{id:"passport_number",value:i.passport_number,onChange:s=>y(t=>({...t,passport_number:s.target.value})),required:!0})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(u,{htmlFor:"address",children:"Resident or hotel address"}),e.jsx(O,{id:"address",value:i.address,onChange:s=>y(t=>({...t,address:s.target.value})),placeholder:"Hotel name + room, or full address",required:!0})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(u,{children:"Contact apps (optional)"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Select any you use, or choose “None of these”."}),e.jsxs("div",{className:"mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3",children:[[{key:"whatsapp",label:"WhatsApp"},{key:"zalo",label:"Zalo"},{key:"wechat",label:"WeChat"},{key:"fb_messenger",label:"Facebook Messenger"}].map(s=>e.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-800",children:[e.jsx(se,{checked:!!i.contact_channels[s.key],onCheckedChange:t=>{const a=t===!0;y(l=>{const c={...l,contact_channels:{...l.contact_channels}};return c.contact_channels[s.key]=a,a&&(c.contact_channels.none=!1),c})}}),s.label]},s.key)),e.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-800",children:[e.jsx(se,{checked:!!i.contact_channels.none,onCheckedChange:s=>{const t=s===!0;y(a=>t?{...a,contact_channels:{whatsapp:!1,zalo:!1,wechat:!1,fb_messenger:!1,none:!0}}:{...a,contact_channels:{...a.contact_channels,none:!1}})}}),"None of these"]})]})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(u,{htmlFor:"notes",children:"Notes (optional)"}),e.jsx(O,{id:"notes",value:i.notes,onChange:s=>y(t=>({...t,notes:s.target.value})),placeholder:"Pickup details, license info, delivery request, etc."})]})]})]})]}),e.jsx("div",{className:"space-y-6",children:e.jsxs(k,{className:"shadow-lg",children:[e.jsxs(S,{children:[e.jsx(q,{children:"Summary"}),e.jsx(P,{children:"Review before submitting."})]}),e.jsxs(I,{className:"space-y-3",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Dates"}),e.jsxs("span",{className:"font-medium",children:[x," → ",g]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Duration"}),e.jsx("span",{className:"font-medium",children:m>0?`${m} day${m===1?"":"s"}`:"—"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Total vehicles"}),e.jsx("span",{className:"font-medium",children:G})]})]}),e.jsx("div",{className:"border-t pt-3",children:C.length===0?e.jsx("p",{className:"text-sm text-gray-600",children:"No vehicles selected yet."}):e.jsx("ul",{className:"space-y-2",children:C.map(s=>e.jsxs("li",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-800",children:ie[s.vehicleId]?.name||"Vehicle"}),e.jsxs("span",{className:"font-medium",children:["× ",s.qty]})]},s.vehicleId))})})]}),e.jsxs("div",{className:"p-6 pt-0",children:[e.jsx(ee,{type:"submit",disabled:$||E||D||m<=0||G<=0,className:"w-full bg-blue-600 hover:bg-blue-700",children:$?"Submitting…":"Submit booking request"}),e.jsx("p",{className:"text-xs text-gray-500 mt-3",children:"By submitting, you agree we can contact you to confirm availability."})]})]})})]})]})]})]})};export{qe as default};
