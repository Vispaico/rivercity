import{h as ae,w as ne,i as re,r as i,j as e,s as N,l as h,I as k,T as U,B as ie}from"./index-079317ab.js";import{P as le}from"./PageHeader-6edfb62b.js";import{C as w,a as S,b as q,e as D,c as P}from"./card-e9561f3a.js";import{C as Y}from"./checkbox-d05581c4.js";import{t as ce,c as de,d as oe}from"./differenceInCalendarDays-6447d4da.js";import"./check-76e675ff.js";function me(o,l,x){const n=ce(o,x?.in);return isNaN(l)?de(x?.in||o,NaN):(l&&n.setDate(n.getDate()+l),n)}const K=o=>{const l=o.getTimezoneOffset()*6e4;return new Date(o.getTime()-l).toISOString().slice(0,10)},Z=o=>{if(!o)return null;const l=new Date(`${o}T00:00:00`);return Number.isNaN(l.getTime())?null:l},ue=o=>o.reduce((l,x)=>{const n=x.category||"other";return l[n]=l[n]||[],l[n].push(x),l},{}),be=()=>{const o=ae(),[l]=ne(),x=(l.get("vehicle")||"").trim(),{toast:n}=re(),[p,G]=i.useState(()=>K(new Date)),[g,J]=i.useState(()=>K(me(new Date,1))),[f,V]=i.useState([]),[M,A]=i.useState(!0),[L,E]=i.useState({}),[B,O]=i.useState(!1),[F,T]=i.useState({}),[z,$]=i.useState(!1),[Q,R]=i.useState(!1),[r,j]=i.useState({full_name:"",phone:"",email:"",address:"",passport_number:"",contact_channels:{whatsapp:!1,zalo:!1,wechat:!1,fb_messenger:!1,none:!0},notes:""}),b=i.useMemo(()=>Z(p),[p]),y=i.useMemo(()=>Z(g),[g]),m=i.useMemo(()=>!b||!y?0:oe(y,b),[b,y]),C=i.useMemo(()=>Object.entries(F).map(([s,t])=>({vehicleId:s,qty:Number(t)||0})).filter(s=>s.qty>0),[F]),H=i.useMemo(()=>C.reduce((s,t)=>s+t.qty,0),[C]),X=i.useMemo(()=>{const s={};for(const t of f)s[t.id]=t;return s},[f]),ee=i.useMemo(()=>ue(f),[f]);i.useEffect(()=>{(async()=>{if(!N){A(!1);return}A(!0);const{data:t,error:a}=await N.from("vehicles").select("id, category, name, description, image_url, price_per_day, inventory_count, active, sort_order").eq("active",!0).order("sort_order",{ascending:!0}).order("name",{ascending:!0});a?(n({title:"Could not load vehicles",description:a.message,variant:"destructive"}),V([])):V(t||[]),A(!1)})()},[n]),i.useEffect(()=>{(async()=>{if(!N||!p||!g)return;if(!b||!y||m<=0){E({});return}O(!0);const{data:t,error:a}=await N.rpc("get_vehicle_availability",{p_start_date:p,p_end_date:g});if(a)n({title:"Could not check availability",description:a.message,variant:"destructive"}),E({});else{const c={};for(const d of t||[])c[d.vehicle_id]=d.available_count;E(c),T(d=>{const u={...d};for(const[_,v]of Object.entries(c)){const I=Number(u[_]||0),W=Math.max(0,Math.min(I,Number(v)||0));W!==I&&(u[_]=W)}return u})}O(!1)})()},[m,y,g,b,p,n]),i.useEffect(()=>{if(Q||!x||!f.length)return;const s=f.find(t=>t.name?.toLowerCase().includes(x.toLowerCase()));if(!s){R(!0);return}T(t=>Object.values(t).some(a=>Number(a)>0)?t:{...t,[s.id]:1}),R(!0)},[Q,x,f]);const se=(s,t)=>{const a=Number(L[s]??0),c=Number(t),d=Number.isFinite(c)?c:0,u=Math.max(0,Math.min(d,a));T(_=>({..._,[s]:u}))},te=async s=>{if(s.preventDefault(),!N){n({title:"Booking is not configured",description:"Supabase credentials are missing.",variant:"destructive"});return}if(!b||!y||m<=0){n({title:"Invalid dates",description:"Please select a start date and an end date (end must be after start).",variant:"destructive"});return}if(!r.full_name.trim()||!r.phone.trim()){n({title:"Missing contact details",description:"Please enter your name and phone number.",variant:"destructive"});return}if(!r.address.trim()){n({title:"Missing address",description:"Please enter your resident or hotel address.",variant:"destructive"});return}if(!r.passport_number.trim()){n({title:"Missing passport number",description:"Please enter your passport number.",variant:"destructive"});return}if(C.length===0){n({title:"No vehicles selected",description:"Please select at least 1 vehicle.",variant:"destructive"});return}const t=C.map(v=>({vehicle_id:v.vehicleId,quantity:v.qty})),a=Object.entries(r.contact_channels).filter(([v,I])=>v!=="none"&&!!I).map(([v])=>v),c={full_name:r.full_name,phone:r.phone,email:r.email,address:r.address,passport_number:r.passport_number,contact_channels:a,contact_channels_none:r.contact_channels.none||a.length===0,notes:r.notes};$(!0);const{data:d,error:u}=await N.rpc("create_booking",{p_start_date:p,p_end_date:g,p_items:t,p_intake:c});if(u){n({title:"Booking failed",description:u.message,variant:"destructive"}),$(!1);return}n({title:"Booking received",description:"We have received your request and will confirm shortly.",className:"bg-blue-500 text-white"}),o(`/book/success/${d}`)};return e.jsxs("div",{className:"bg-gray-50",children:[e.jsx(le,{title:"Book a Motorbike or Car",subtitle:"Select dates, choose your vehicles, and send your booking request.",breadcrumbs:[{name:"Home",link:"/"},{name:"Book"}]}),e.jsxs("main",{className:"container mx-auto px-4 py-12",children:[!N&&e.jsx(w,{className:"shadow-lg",children:e.jsxs(S,{children:[e.jsx(q,{children:"Booking is not available"}),e.jsxs(D,{children:["Supabase is not configured. Set ",e.jsx("code",{children:"VITE_SUPABASE_URL"})," and ",e.jsx("code",{children:"VITE_SUPABASE_ANON_KEY"}),"."]})]})}),N&&e.jsx("div",{className:"space-y-6",children:e.jsxs("form",{onSubmit:te,className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs(w,{className:"shadow-lg",children:[e.jsxs(S,{children:[e.jsx(q,{children:"1) Choose your dates"}),e.jsx(D,{children:"Dates are treated as: pickup on start date, return on end date."})]}),e.jsxs(P,{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(h,{htmlFor:"start_date",children:"Start date"}),e.jsx(k,{id:"start_date",type:"date",value:p,onChange:s=>G(s.target.value),required:!0})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"end_date",children:"End date"}),e.jsx(k,{id:"end_date",type:"date",value:g,onChange:s=>J(s.target.value),required:!0})]}),e.jsx("div",{className:"sm:col-span-2 text-sm text-gray-700",children:m>0?e.jsxs("span",{children:["Rental duration: ",e.jsx("span",{className:"font-semibold",children:m})," day",m===1?"":"s"]}):e.jsx("span",{className:"text-red-600",children:"Please select a valid date range (end date must be after start date)."})})]})]}),e.jsxs(w,{className:"shadow-lg",children:[e.jsxs(S,{children:[e.jsx(q,{children:"2) Select vehicles"}),e.jsx(D,{children:M?"Loading vehicles…":B?"Checking availability…":"Choose quantities (limited by availability)."})]}),e.jsxs(P,{className:"space-y-8",children:[!M&&f.length===0&&e.jsxs("p",{className:"text-gray-700",children:["No vehicles found. Add records to the ",e.jsx("code",{children:"vehicles"})," table."]}),Object.entries(ee).map(([s,t])=>e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 capitalize",children:s}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:t.map(a=>{const c=Number(L[a.id]??0),d=Number(F[a.id]??0),u=!b||!y||m<=0||B;return e.jsx(w,{className:"border border-gray-200",children:e.jsxs(P,{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start gap-4",children:[a.image_url?e.jsx("img",{src:a.image_url,alt:a.name,className:"h-16 w-24 object-cover rounded-md border",loading:"lazy"}):e.jsx("div",{className:"h-16 w-24 rounded-md border bg-gray-100"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("p",{className:"font-semibold text-gray-900",children:a.name}),typeof a.price_per_day=="number"||a.price_per_day?e.jsxs("p",{className:"text-sm text-gray-700",children:["$",Number(a.price_per_day),"/day"]}):null]}),a.description?e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:a.description}):null]})]}),e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Available: "}),e.jsx("span",{className:c>0?"font-semibold text-green-700":"font-semibold text-gray-700",children:B||!b||!y||m<=0?"—":c})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{htmlFor:`qty_${a.id}`,className:"text-sm text-gray-700",children:"Qty"}),e.jsx(k,{id:`qty_${a.id}`,type:"number",min:0,max:c,value:d,disabled:u,onChange:_=>se(a.id,_.target.value),className:"w-24"})]})]})]})},a.id)})})]},s))]})]}),e.jsxs(w,{className:"shadow-lg",children:[e.jsxs(S,{children:[e.jsx(q,{children:"3) Your details"}),e.jsx(D,{children:"We’ll contact you to confirm. Payment is cash on arrival."})]}),e.jsxs(P,{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(h,{htmlFor:"full_name",children:"Full name"}),e.jsx(k,{id:"full_name",value:r.full_name,onChange:s=>j(t=>({...t,full_name:s.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"phone",children:"Phone number"}),e.jsx(k,{id:"phone",value:r.phone,onChange:s=>j(t=>({...t,phone:s.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"email",children:"Email (optional)"}),e.jsx(k,{id:"email",type:"email",value:r.email,onChange:s=>j(t=>({...t,email:s.target.value}))})]}),e.jsxs("div",{children:[e.jsx(h,{htmlFor:"passport_number",children:"Passport number"}),e.jsx(k,{id:"passport_number",value:r.passport_number,onChange:s=>j(t=>({...t,passport_number:s.target.value})),required:!0})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(h,{htmlFor:"address",children:"Resident or hotel address"}),e.jsx(U,{id:"address",value:r.address,onChange:s=>j(t=>({...t,address:s.target.value})),placeholder:"Hotel name + room, or full address",required:!0})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(h,{children:"Contact apps (optional)"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Select any you use, or choose “None of these”."}),e.jsxs("div",{className:"mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3",children:[[{key:"whatsapp",label:"WhatsApp"},{key:"zalo",label:"Zalo"},{key:"wechat",label:"WeChat"},{key:"fb_messenger",label:"Facebook Messenger"}].map(s=>e.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-800",children:[e.jsx(Y,{checked:!!r.contact_channels[s.key],onCheckedChange:t=>{const a=t===!0;j(c=>{const d={...c,contact_channels:{...c.contact_channels}};return d.contact_channels[s.key]=a,a&&(d.contact_channels.none=!1),d})}}),s.label]},s.key)),e.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-800",children:[e.jsx(Y,{checked:!!r.contact_channels.none,onCheckedChange:s=>{const t=s===!0;j(a=>t?{...a,contact_channels:{whatsapp:!1,zalo:!1,wechat:!1,fb_messenger:!1,none:!0}}:{...a,contact_channels:{...a.contact_channels,none:!1}})}}),"None of these"]})]})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(h,{htmlFor:"notes",children:"Notes (optional)"}),e.jsx(U,{id:"notes",value:r.notes,onChange:s=>j(t=>({...t,notes:s.target.value})),placeholder:"Pickup details, license info, delivery request, etc."})]})]})]})]}),e.jsx("div",{className:"space-y-6",children:e.jsxs(w,{className:"shadow-lg",children:[e.jsxs(S,{children:[e.jsx(q,{children:"Summary"}),e.jsx(D,{children:"Review before submitting."})]}),e.jsxs(P,{className:"space-y-3",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Dates"}),e.jsxs("span",{className:"font-medium",children:[p," → ",g]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Duration"}),e.jsx("span",{className:"font-medium",children:m>0?`${m} day${m===1?"":"s"}`:"—"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Total vehicles"}),e.jsx("span",{className:"font-medium",children:H})]})]}),e.jsx("div",{className:"border-t pt-3",children:C.length===0?e.jsx("p",{className:"text-sm text-gray-600",children:"No vehicles selected yet."}):e.jsx("ul",{className:"space-y-2",children:C.map(s=>e.jsxs("li",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-800",children:X[s.vehicleId]?.name||"Vehicle"}),e.jsxs("span",{className:"font-medium",children:["× ",s.qty]})]},s.vehicleId))})})]}),e.jsxs("div",{className:"p-6 pt-0",children:[e.jsx(ie,{type:"submit",disabled:z||M||B||m<=0||H<=0,className:"w-full bg-blue-600 hover:bg-blue-700",children:z?"Submitting…":"Submit booking request"}),e.jsx("p",{className:"text-xs text-gray-500 mt-3",children:"By submitting, you agree we can contact you to confirm availability."})]})]})})]})})]})]})};export{be as default};
