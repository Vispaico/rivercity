import{n as be,k as _e,r as l,j as e,q as n,I as d,B as p}from"./index-6dbfcf98.js";import{P as ve}from"./PageHeader-68f62671.js";import{C as b,a as _,b as v,e as f,c as C}from"./card-bed98294.js";import{L as c}from"./label-a3d96b0f.js";import{T as ce}from"./textarea-0deeea5b.js";import{T as fe,a as je,b as M,c as $}from"./tabs-f25806bd.js";const F=r=>{const s=Number(r);return Number.isFinite(s)?s:null},Pe=()=>{const{user:r}=be(),{toast:s}=_e(),[P,B]=l.useState(!0),[W,E]=l.useState(!1),[i,x]=l.useState({full_name:"",phone:"",bank_account_name:"",bank_name:"",bank_account_number:"",bank_branch:"",payout_notes:""}),[A,z]=l.useState(!1),[H,G]=l.useState(!1),[y,Y]=l.useState([]),[J,R]=l.useState(!1),[K,V]=l.useState(null),[u,k]=l.useState({category:"motorbike",name:"",description:"",image_url:""}),[Q,X]=l.useState(!1),[T,D]=l.useState([]),[o,N]=l.useState({vehicle_id:"",start_date:"",end_date:"",reason:""}),[Z,L]=l.useState(!1),[ee,ae]=l.useState(null),[U,te]=l.useState([]),[se,ne]=l.useState(!1),ie=l.useMemo(()=>y.filter(a=>a.listing_status==="approved"&&a.active),[y]),g=async()=>{if(!n||!r){B(!1);return}B(!0),E(!1);const[a,t]=await Promise.all([n.from("owner_profiles").select("*").eq("user_id",r.id).maybeSingle(),n.from("vehicles").select("id, category, name, description, image_url, active, listing_status, submitted_at, approved_at, rejected_at, rejection_reason, price_per_day, created_at").eq("owner_user_id",r.id).order("created_at",{ascending:!1})]),m=a.error?.message||t.error?.message;if(m&&/relation .* does not exist|column .* does not exist/i.test(m)){E(!0),B(!1);return}a.error?s({title:"Could not load payout profile",description:a.error.message,variant:"destructive"}):a.data&&(x({full_name:a.data.full_name||"",phone:a.data.phone||"",bank_account_name:a.data.bank_account_name||"",bank_name:a.data.bank_name||"",bank_account_number:a.data.bank_account_number||"",bank_branch:a.data.bank_branch||"",payout_notes:a.data.payout_notes||""}),z(!!a.data.insurance_ack_at)),t.error?(s({title:"Could not load your vehicles",description:t.error.message,variant:"destructive"}),Y([])):(Y(t.data||[]),N(h=>{if(h.vehicle_id)return h;const j=(t.data||[]).find(I=>I.listing_status==="approved"&&I.active);return{...h,vehicle_id:j?.id||""}}));const w=(t.data||[]).map(h=>h.id).filter(Boolean);if(w.length===0)D([]);else{const{data:h,error:j}=await n.from("vehicle_unavailability").select("id, vehicle_id, start_date, end_date, reason, created_at").in("vehicle_id",w).order("start_date",{ascending:!0});if(j){if(/relation .* does not exist|column .* does not exist/i.test(j.message)){E(!0),B(!1);return}s({title:"Could not load availability blocks",description:j.message,variant:"destructive"}),D([])}else D(h||[])}B(!1)},le=async()=>{if(!n||!r)return;ne(!0);const{data:a,error:t}=await n.from("payouts").select("id, booking_id, gross_amount, platform_fee_amount, net_amount, eligible_at, status, paid_at, payment_reference, created_at").eq("owner_user_id",r.id).order("created_at",{ascending:!1});t?(/relation .* does not exist/i.test(t.message)?E(!0):s({title:"Could not load payouts",description:t.message,variant:"destructive"}),te([])):te(a||[]),ne(!1)};l.useEffect(()=>{g()},[r?.id]),l.useEffect(()=>{le()},[r?.id]);const oe=async()=>{if(!n||!r)return;G(!0);const a={user_id:r.id,full_name:i.full_name||null,phone:i.phone||null,bank_account_name:i.bank_account_name||null,bank_name:i.bank_name||null,bank_account_number:i.bank_account_number||null,bank_branch:i.bank_branch||null,payout_notes:i.payout_notes||null,insurance_ack_at:A?new Date().toISOString():null,updated_at:new Date().toISOString()},{error:t}=await n.from("owner_profiles").upsert(a,{onConflict:"user_id"});s(t?{title:"Save failed",description:t.message,variant:"destructive"}:{title:"Saved",description:"Payout details updated.",className:"bg-blue-500 text-white"}),G(!1)},de=async()=>{if(!n||!r)return;const a=u.name.trim();if(!a){s({title:"Name required",description:"Enter a vehicle name.",variant:"destructive"});return}if(!A){s({title:"Insurance required",description:"Please confirm you have the required insurance before submitting vehicles.",variant:"destructive"});return}const{error:t}=await n.from("owner_profiles").upsert({user_id:r.id,full_name:i.full_name||null,phone:i.phone||null,bank_account_name:i.bank_account_name||null,bank_name:i.bank_name||null,bank_account_number:i.bank_account_number||null,bank_branch:i.bank_branch||null,payout_notes:i.payout_notes||null,insurance_ack_at:new Date().toISOString(),updated_at:new Date().toISOString()},{onConflict:"user_id"});if(t){s({title:"Could not save payout profile",description:t.message,variant:"destructive"});return}R(!0);const{error:m}=await n.from("vehicles").insert([{owner_user_id:r.id,category:u.category,name:a,description:u.description.trim()||null,image_url:u.image_url.trim()||null,inventory_count:1,active:!1,listing_status:"draft",price_per_day:null}]);if(m){s({title:"Create failed",description:m.message,variant:"destructive"}),R(!1);return}s({title:"Created",description:"Vehicle saved as draft.",className:"bg-blue-500 text-white"}),k({category:"motorbike",name:"",description:"",image_url:""}),await g(),R(!1)},ue=async a=>{if(!(!n||!r)&&a){if(!a.type?.startsWith("image/")){s({title:"Invalid file",description:"Please choose an image.",variant:"destructive"});return}if(a.size>8*1024*1024){s({title:"File too large",description:"Please upload an image up to 8MB.",variant:"destructive"});return}X(!0);try{const{data:{session:t},error:m}=await n.auth.getSession();if(m||!t?.access_token)throw new Error("You must be signed in to upload images.");const w=await fetch("/api/cloudinary-sign",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.access_token}`},body:JSON.stringify({})});if(!w.ok){const O=await w.json().catch(()=>null);throw new Error(O?.error||"Could not prepare upload.")}const{cloudName:h,apiKey:j,folder:I,timestamp:xe,signature:ge}=await w.json(),S=new FormData;S.append("file",a),S.append("api_key",j),S.append("timestamp",String(xe)),S.append("signature",ge),S.append("folder",I);const re=await fetch(`https://api.cloudinary.com/v1_1/${h}/image/upload`,{method:"POST",body:S}),q=await re.json().catch(()=>null);if(!re.ok)throw new Error(q?.error?.message||"Upload failed.");if(!q?.secure_url)throw new Error("Upload failed (missing URL).");k(O=>({...O,image_url:q.secure_url})),s({title:"Uploaded",description:"Image uploaded successfully.",className:"bg-blue-500 text-white"})}catch(t){s({title:"Upload failed",description:t?.message||"Please try again.",variant:"destructive"})}finally{X(!1)}}},me=async a=>{if(!n)return;V(a);const{error:t}=await n.rpc("submit_vehicle_for_approval",{p_vehicle_id:a});if(t){s({title:"Submit failed",description:t.message,variant:"destructive"}),V(null);return}s({title:"Submitted",description:"We will review and set pricing.",className:"bg-blue-500 text-white"}),await g(),V(null)},he=async()=>{if(!n||!r)return;if(!o.vehicle_id){s({title:"Choose a vehicle",description:"Select a vehicle first.",variant:"destructive"});return}if(!o.start_date||!o.end_date){s({title:"Dates required",description:"Select a start and end date.",variant:"destructive"});return}if(o.end_date<=o.start_date){s({title:"Invalid dates",description:"End date must be after start date.",variant:"destructive"});return}L(!0);const{error:a}=await n.from("vehicle_unavailability").insert([{vehicle_id:o.vehicle_id,start_date:o.start_date,end_date:o.end_date,reason:o.reason.trim()||null,created_by:r.id}]);if(a){s({title:"Could not save block",description:a.message,variant:"destructive"}),L(!1);return}s({title:"Saved",description:"Availability updated.",className:"bg-blue-500 text-white"}),N(t=>({...t,start_date:"",end_date:"",reason:""})),await g(),L(!1)},pe=async a=>{if(!n)return;ae(a);const{error:t}=await n.from("vehicle_unavailability").delete().eq("id",a);t?s({title:"Delete failed",description:t.message,variant:"destructive"}):(s({title:"Removed",description:"Block deleted.",className:"bg-blue-500 text-white"}),await g()),ae(null)};return e.jsxs("div",{className:"bg-gray-50",children:[e.jsx(ve,{title:"Partner Portal",subtitle:"List your vehicle, manage availability, and track payouts.",breadcrumbs:[{name:"Home",link:"/"},{name:"Dashboard",link:"/dashboard"},{name:"Partner Portal"}]}),e.jsxs("main",{className:"container mx-auto px-4 py-12 space-y-6",children:[!n&&e.jsx(b,{className:"shadow-lg",children:e.jsxs(_,{children:[e.jsx(v,{children:"Supabase not configured"}),e.jsx(f,{children:"Set VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY to enable the partner portal."})]})}),n&&W&&e.jsx(b,{className:"shadow-lg border border-yellow-200",children:e.jsxs(_,{children:[e.jsx(v,{children:"Marketplace schema not installed"}),e.jsxs(f,{children:["Run ",e.jsx("code",{children:"supabase/partner_marketplace_schema.sql"})," in the Supabase SQL editor, then refresh this page."]})]})}),n&&!W&&e.jsxs(fe,{defaultValue:"vehicles",className:"w-full",children:[e.jsxs(je,{className:"grid w-full grid-cols-1 sm:grid-cols-3 bg-white shadow-sm",children:[e.jsx(M,{value:"vehicles",children:"My Vehicles"}),e.jsx(M,{value:"availability",children:"Availability"}),e.jsx(M,{value:"payouts",children:"Payouts"})]}),e.jsxs($,{value:"vehicles",className:"mt-6 space-y-6",children:[e.jsxs(b,{className:"shadow-lg",children:[e.jsxs(_,{children:[e.jsx(v,{children:"Payout details (bank transfer)"}),e.jsx(f,{children:"We pay 70% to the owner, 7 days after the rental is completed. Owners are responsible for insurance."})]}),e.jsxs(C,{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(c,{htmlFor:"full_name",children:"Full name"}),e.jsx(d,{id:"full_name",value:i.full_name,onChange:a=>x(t=>({...t,full_name:a.target.value}))})]}),e.jsxs("div",{children:[e.jsx(c,{htmlFor:"phone",children:"Phone"}),e.jsx(d,{id:"phone",value:i.phone,onChange:a=>x(t=>({...t,phone:a.target.value}))})]}),e.jsxs("div",{children:[e.jsx(c,{htmlFor:"bank_account_name",children:"Bank account name"}),e.jsx(d,{id:"bank_account_name",value:i.bank_account_name,onChange:a=>x(t=>({...t,bank_account_name:a.target.value}))})]}),e.jsxs("div",{children:[e.jsx(c,{htmlFor:"bank_name",children:"Bank name"}),e.jsx(d,{id:"bank_name",value:i.bank_name,onChange:a=>x(t=>({...t,bank_name:a.target.value}))})]}),e.jsxs("div",{children:[e.jsx(c,{htmlFor:"bank_account_number",children:"Bank account number"}),e.jsx(d,{id:"bank_account_number",value:i.bank_account_number,onChange:a=>x(t=>({...t,bank_account_number:a.target.value}))})]}),e.jsxs("div",{children:[e.jsx(c,{htmlFor:"bank_branch",children:"Branch (optional)"}),e.jsx(d,{id:"bank_branch",value:i.bank_branch,onChange:a=>x(t=>({...t,bank_branch:a.target.value}))})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(c,{htmlFor:"payout_notes",children:"Notes (optional)"}),e.jsx(ce,{id:"payout_notes",value:i.payout_notes,onChange:a=>x(t=>({...t,payout_notes:a.target.value})),placeholder:"Anything we should know about payouts"})]}),e.jsxs("div",{className:"md:col-span-2 flex items-center justify-between gap-3",children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-800",children:[e.jsx("input",{type:"checkbox",checked:A,onChange:a=>z(a.target.checked)}),"I confirm I have the insurance required to rent out this vehicle."]}),e.jsx(p,{type:"button",onClick:oe,disabled:H,className:"bg-blue-600 hover:bg-blue-700",children:H?"Saving…":"Save"})]})]})]}),e.jsxs(b,{className:"shadow-lg",children:[e.jsxs(_,{children:[e.jsx(v,{children:"Add a vehicle"}),e.jsx(f,{children:"We review and set the rental price. Drafts are not visible publicly."})]}),e.jsxs(C,{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(c,{htmlFor:"new_category",children:"Category"}),e.jsxs("select",{id:"new_category",className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm",value:u.category,onChange:a=>k(t=>({...t,category:a.target.value})),children:[e.jsx("option",{value:"motorbike",children:"Motorbike"}),e.jsx("option",{value:"car",children:"Car"})]})]}),e.jsxs("div",{children:[e.jsx(c,{htmlFor:"new_name",children:"Vehicle name"}),e.jsx(d,{id:"new_name",value:u.name,onChange:a=>k(t=>({...t,name:a.target.value})),placeholder:"e.g. Honda Airblade 2020"})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(c,{htmlFor:"new_desc",children:"Description (optional)"}),e.jsx(ce,{id:"new_desc",value:u.description,onChange:a=>k(t=>({...t,description:a.target.value})),placeholder:"Condition, transmission, extras, etc."})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(c,{children:"Vehicle image (optional)"}),e.jsxs("div",{className:"mt-2 grid grid-cols-1 md:grid-cols-2 gap-3 items-start",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-gray-700",children:"Upload image"}),e.jsx("input",{type:"file",accept:"image/*",disabled:Q,onChange:a=>{const t=a.target.files?.[0]||null;t&&ue(t),a.target.value=""},className:"mt-1 block w-full text-sm"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"PNG/JPG/WebP up to 8MB."})]}),e.jsxs("div",{children:[e.jsx(c,{htmlFor:"new_image",children:"Or paste image URL"}),e.jsx(d,{id:"new_image",value:u.image_url,onChange:a=>k(t=>({...t,image_url:a.target.value})),placeholder:"https://..."})]})]}),u.image_url?e.jsxs("div",{className:"mt-3",children:[e.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"Preview"}),e.jsx("img",{src:u.image_url,alt:"Vehicle preview",className:"h-24 w-40 object-cover rounded-md border",loading:"lazy"})]}):null]}),e.jsxs("div",{className:"md:col-span-2 flex gap-3",children:[e.jsx(p,{type:"button",onClick:de,disabled:J||Q,className:"bg-blue-600 hover:bg-blue-700",children:J?"Saving…":"Create draft"}),e.jsx(p,{type:"button",variant:"outline",onClick:g,disabled:P,children:"Refresh"})]})]})]}),e.jsxs(b,{className:"shadow-lg",children:[e.jsxs(_,{children:[e.jsx(v,{children:"My vehicles"}),e.jsx(f,{children:P?"Loading…":`${y.length} total`})]}),e.jsxs(C,{className:"space-y-4",children:[y.length===0&&e.jsx("p",{className:"text-gray-700",children:"No vehicles yet."}),y.map(a=>e.jsxs("div",{className:"p-4 bg-white border rounded-lg space-y-2",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-gray-900",children:a.name}),e.jsx("p",{className:"text-sm text-gray-600 capitalize",children:a.category}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Status: ",e.jsx("span",{className:"font-semibold",children:a.listing_status})]}),a.rejection_reason?e.jsxs("p",{className:"text-xs text-red-600",children:["Reason: ",a.rejection_reason]}):null]}),e.jsxs("div",{className:"text-sm text-gray-700",children:[a.price_per_day?e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold",children:"Price:"})," $",F(a.price_per_day),"/day"]}):e.jsx("p",{className:"text-gray-500",children:"Price: pending"}),e.jsx("p",{className:a.active?"text-green-700 font-semibold":"text-gray-600 font-semibold",children:a.active?"Active":"Inactive"})]})]}),a.description?e.jsx("p",{className:"text-sm text-gray-700",children:a.description}):null,e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsx(p,{type:"button",onClick:()=>me(a.id),disabled:K===a.id||!["draft","rejected"].includes(a.listing_status),className:"bg-blue-600 hover:bg-blue-700",children:K===a.id?"Submitting…":"Submit for approval"}),e.jsx(p,{type:"button",variant:"outline",onClick:g,disabled:P,children:"Refresh"})]})]},a.id))]})]})]}),e.jsxs($,{value:"availability",className:"mt-6 space-y-6",children:[e.jsxs(b,{className:"shadow-lg",children:[e.jsxs(_,{children:[e.jsx(v,{children:"Block dates (owner-controlled availability)"}),e.jsx(f,{children:"Blocked dates make your vehicle unavailable for customer bookings."})]}),e.jsxs(C,{className:"grid grid-cols-1 md:grid-cols-4 gap-4 items-end",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(c,{htmlFor:"block_vehicle",children:"Vehicle"}),e.jsxs("select",{id:"block_vehicle",className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm",value:o.vehicle_id,onChange:a=>N(t=>({...t,vehicle_id:a.target.value})),children:[e.jsx("option",{value:"",children:"Select…"}),ie.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]}),ie.length===0?e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"You’ll be able to block dates after a vehicle is approved and active."}):null]}),e.jsxs("div",{children:[e.jsx(c,{htmlFor:"block_start",children:"Start"}),e.jsx(d,{id:"block_start",type:"date",value:o.start_date,onChange:a=>N(t=>({...t,start_date:a.target.value}))})]}),e.jsxs("div",{children:[e.jsx(c,{htmlFor:"block_end",children:"End"}),e.jsx(d,{id:"block_end",type:"date",value:o.end_date,onChange:a=>N(t=>({...t,end_date:a.target.value}))})]}),e.jsxs("div",{className:"md:col-span-4",children:[e.jsx(c,{htmlFor:"block_reason",children:"Reason (optional)"}),e.jsx(d,{id:"block_reason",value:o.reason,onChange:a=>N(t=>({...t,reason:a.target.value})),placeholder:"Maintenance, personal use, etc."})]}),e.jsxs("div",{className:"md:col-span-4 flex gap-3",children:[e.jsx(p,{type:"button",onClick:he,disabled:Z||!o.vehicle_id,className:"bg-blue-600 hover:bg-blue-700",children:Z?"Saving…":"Add block"}),e.jsx(p,{type:"button",variant:"outline",onClick:g,disabled:P,children:"Refresh"})]})]})]}),e.jsxs(b,{className:"shadow-lg",children:[e.jsxs(_,{children:[e.jsx(v,{children:"Existing blocks"}),e.jsx(f,{children:P?"Loading…":`${T.length} total`})]}),e.jsxs(C,{className:"space-y-3",children:[T.length===0?e.jsx("p",{className:"text-gray-700",children:"No blocks."}):null,T.map(a=>{const t=y.find(m=>m.id===a.vehicle_id);return e.jsxs("div",{className:"p-4 bg-white border rounded-lg flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"font-semibold text-gray-900",children:t?.name||a.vehicle_id}),e.jsxs("p",{className:"text-gray-700",children:[a.start_date," → ",a.end_date]}),a.reason?e.jsx("p",{className:"text-gray-500",children:a.reason}):null]}),e.jsx(p,{type:"button",variant:"outline",onClick:()=>pe(a.id),disabled:ee===a.id,children:ee===a.id?"Removing…":"Remove"})]},a.id)})]})]})]}),e.jsx($,{value:"payouts",className:"mt-6 space-y-6",children:e.jsxs(b,{className:"shadow-lg",children:[e.jsxs(_,{children:[e.jsx(v,{children:"Payouts"}),e.jsx(f,{children:se?"Loading…":`${U.length} total`})]}),e.jsxs(C,{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-700",children:e.jsxs("p",{children:["Owner share: ",e.jsx("span",{className:"font-semibold",children:"70%"}),". Eligible: ",e.jsx("span",{className:"font-semibold",children:"7 days"})," after completion."]})}),U.length===0?e.jsx("p",{className:"text-gray-700",children:"No payouts yet."}):null,U.map(a=>e.jsx("div",{className:"p-4 bg-white border rounded-lg",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between gap-2",children:[e.jsxs("div",{className:"text-sm",children:[e.jsxs("p",{className:"font-semibold text-gray-900",children:["Booking: ",e.jsx("code",{className:"break-all",children:a.booking_id})]}),e.jsxs("p",{className:"text-gray-700",children:["Status: ",e.jsx("span",{className:"font-semibold",children:a.status})]}),e.jsxs("p",{className:"text-gray-700",children:["Eligible at: ",e.jsx("span",{className:"font-semibold",children:a.eligible_at})]}),a.paid_at?e.jsxs("p",{className:"text-green-700 font-semibold",children:["Paid at: ",a.paid_at]}):null,a.payment_reference?e.jsxs("p",{className:"text-gray-600",children:["Ref: ",a.payment_reference]}):null]}),e.jsxs("div",{className:"text-sm text-gray-800",children:[e.jsxs("p",{children:["Gross: ",e.jsxs("span",{className:"font-semibold",children:["$",F(a.gross_amount)]})]}),e.jsxs("p",{children:["Fee (30%): ",e.jsxs("span",{className:"font-semibold",children:["$",F(a.platform_fee_amount)]})]}),e.jsxs("p",{children:["Net (70%): ",e.jsxs("span",{className:"font-semibold",children:["$",F(a.net_amount)]})]})]})]})},a.id)),e.jsx("div",{className:"flex gap-3",children:e.jsx(p,{type:"button",variant:"outline",onClick:le,disabled:se,children:"Refresh"})})]})]})})]})]})]})};export{Pe as default};
