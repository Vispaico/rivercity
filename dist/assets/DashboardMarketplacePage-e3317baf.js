import{i as oe,r as c,j as e,s as l,l as _,I as w,B as o,T as me}from"./index-b173813a.js";import{P as pe}from"./PageHeader-209ca54a.js";import{T as ue,a as xe,b as T,c as D}from"./tabs-91ff8cf8.js";import{C as u,a as x,b as h,e as g,c as v}from"./card-04011f32.js";const d=i=>{const m=Number(i);return Number.isFinite(m)?m:null},he=i=>{if(!i)return!1;const m=new Date(i);return Number.isFinite(m.getTime())&&m.getTime()<=Date.now()},be=()=>{const{toast:i}=oe(),[m,p]=c.useState(!1),[P,S]=c.useState(!0),[j,E]=c.useState([]),[U,F]=c.useState({}),[W,q]=c.useState({}),[O,z]=c.useState({}),[H,C]=c.useState(null),[V,B]=c.useState(null),[G,ne]=c.useState({}),[K,$]=c.useState(!0),[Q,Y]=c.useState([]),[f,b]=c.useState(null),[J,R]=c.useState(!0),[L,X]=c.useState([]),[Z,ee]=c.useState(null),[se,ae]=c.useState({}),A=c.useMemo(()=>j.filter(s=>s.listing_status==="submitted"),[j]),y=async()=>{if(!l){S(!1);return}S(!0);const{data:s,error:a}=await l.from("vehicles").select("id, category, name, description, image_url, owner_user_id, listing_status, submitted_at, approved_at, rejected_at, rejection_reason, price_per_day, price_per_week, price_per_month, active, created_at").not("owner_user_id","is",null).order("submitted_at",{ascending:!1}).order("created_at",{ascending:!1});a?(/column .* does not exist|relation .* does not exist/i.test(a.message)&&p(!0),i({title:"Could not load partner listings",description:a.message,variant:"destructive"}),E([])):(p(!1),E(s||[]),F(t=>{const n={...t};for(const r of s||[])n[r.id]===void 0&&(n[r.id]=r.price_per_day??"");return n}),q(t=>{const n={...t};for(const r of s||[])n[r.id]===void 0&&(n[r.id]=r.price_per_week??"");return n}),z(t=>{const n={...t};for(const r of s||[])n[r.id]===void 0&&(n[r.id]=r.price_per_month??"");return n})),S(!1)},N=async()=>{if(!l){$(!1);return}$(!0);const{data:s,error:a}=await l.from("bookings").select("id, start_date, end_date, status, created_at, completed_at, intake, booking_items(id, quantity, unit_price_per_day, vehicle_owner_user_id, vehicles(id, name, category, owner_user_id))").order("created_at",{ascending:!1}).limit(50);a?(/column .* does not exist|relation .* does not exist/i.test(a.message)&&p(!0),i({title:"Could not load bookings",description:a.message,variant:"destructive"}),Y([])):(p(!1),Y(s||[])),$(!1)},k=async()=>{if(!l){R(!1);return}R(!0);const{data:s,error:a}=await l.from("payouts").select("id, booking_id, owner_user_id, gross_amount, platform_fee_amount, net_amount, eligible_at, status, paid_at, payment_reference, created_at, owner_profiles(full_name, phone, bank_account_name, bank_name, bank_account_number, bank_branch, payout_notes)").order("created_at",{ascending:!1}).limit(100);a?(/relation .* does not exist/i.test(a.message)&&p(!0),i({title:"Could not load payouts",description:a.message,variant:"destructive"}),X([])):(p(!1),X(s||[]),ae(t=>{const n={...t};for(const r of s||[])n[r.id]===void 0&&(n[r.id]=r.payment_reference??"");return n})),R(!1)};c.useEffect(()=>{y(),N(),k()},[]);const re=async s=>{if(!l)return;const a=U[s],t=W[s],n=O[s],r=d(a),M=d(t),I=d(n);if(!r||r<=0){i({title:"Price required",description:"Enter a valid price/day.",variant:"destructive"});return}if(M!==null&&M<=0){i({title:"Weekly price invalid",description:"Weekly price must be blank or greater than 0.",variant:"destructive"});return}if(I!==null&&I<=0){i({title:"Monthly price invalid",description:"Monthly price must be blank or greater than 0.",variant:"destructive"});return}C(s);const{error:ie}=await l.rpc("approve_vehicle_listing",{p_vehicle_id:s,p_price_per_day:r,p_price_per_week:M,p_price_per_month:I});if(ie){i({title:"Approve failed",description:ie.message,variant:"destructive"}),C(null);return}i({title:"Approved",description:"Listing is now public & bookable.",className:"bg-blue-500 text-white"}),await y(),C(null)},le=async s=>{if(!l)return;B(s);const a=(G[s]||"").trim()||null,{error:t}=await l.rpc("reject_vehicle_listing",{p_vehicle_id:s,p_reason:a});if(t){i({title:"Reject failed",description:t.message,variant:"destructive"}),B(null);return}i({title:"Rejected",description:"Owner can edit and resubmit.",className:"bg-blue-500 text-white"}),await y(),B(null)},te=async(s,a)=>{if(!l)return;b(s);const{error:t}=await l.rpc("set_booking_status",{p_booking_id:s,p_status:a});t?i({title:"Update failed",description:t.message,variant:"destructive"}):(i({title:"Updated",description:`Booking marked ${a}.`,className:"bg-blue-500 text-white"}),await N()),b(null)},ce=async s=>{if(!l)return;b(s);const{error:a}=await l.rpc("complete_booking_and_create_payouts",{p_booking_id:s});a?i({title:"Complete failed",description:a.message,variant:"destructive"}):(i({title:"Completed",description:"Payouts created (eligible in 7 days).",className:"bg-blue-500 text-white"}),await Promise.all([N(),k()])),b(null)},de=async s=>{if(!l)return;ee(s);const a=(se[s]||"").trim()||null,{error:t}=await l.rpc("mark_payout_paid",{p_payout_id:s,p_payment_reference:a});t?i({title:"Mark paid failed",description:t.message,variant:"destructive"}):(i({title:"Paid",description:"Payout marked as paid.",className:"bg-blue-500 text-white"}),await k()),ee(null)};return e.jsxs("div",{className:"bg-gray-50",children:[e.jsx(pe,{title:"Marketplace Admin",subtitle:"Approve partner listings, manage bookings, and track manual payouts.",breadcrumbs:[{name:"Home",link:"/"},{name:"Dashboard",link:"/dashboard"},{name:"Marketplace"}]}),e.jsxs("main",{className:"container mx-auto px-4 py-12 space-y-6",children:[!l&&e.jsx(u,{className:"shadow-lg",children:e.jsxs(x,{children:[e.jsx(h,{children:"Supabase not configured"}),e.jsx(g,{children:"Set VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY to enable marketplace admin tools."})]})}),l&&m&&e.jsx(u,{className:"shadow-lg border border-yellow-200",children:e.jsxs(x,{children:[e.jsx(h,{children:"Marketplace schema not installed"}),e.jsxs(g,{children:["Run ",e.jsx("code",{children:"supabase/partner_marketplace_schema.sql"})," in the Supabase SQL editor, then refresh."]})]})}),l&&!m&&e.jsxs(ue,{defaultValue:"listings",className:"w-full",children:[e.jsxs(xe,{className:"grid w-full grid-cols-1 sm:grid-cols-3 bg-white shadow-sm",children:[e.jsx(T,{value:"listings",children:"Listings"}),e.jsx(T,{value:"bookings",children:"Bookings"}),e.jsx(T,{value:"payouts",children:"Payouts"})]}),e.jsxs(D,{value:"listings",className:"mt-6 space-y-6",children:[e.jsxs(u,{className:"shadow-lg",children:[e.jsxs(x,{children:[e.jsx(h,{children:"Submitted listings"}),e.jsx(g,{children:P?"Loading…":`${A.length} submitted`})]}),e.jsxs(v,{className:"space-y-4",children:[A.length===0?e.jsx("p",{className:"text-gray-700",children:"No pending submissions."}):null,A.map(s=>e.jsxs("div",{className:"p-4 bg-white border rounded-lg space-y-3",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-start md:justify-between gap-3",children:[e.jsxs("div",{className:"flex gap-4",children:[s.image_url?e.jsx("img",{src:s.image_url,alt:s.name,className:"h-16 w-24 object-cover rounded-md border",loading:"lazy"}):e.jsx("div",{className:"h-16 w-24 rounded-md border bg-gray-100"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-gray-900",children:s.name}),e.jsx("p",{className:"text-sm text-gray-600 capitalize",children:s.category}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Owner: ",e.jsx("code",{className:"break-all",children:s.owner_user_id})]}),s.description?e.jsx("p",{className:"text-sm text-gray-700 mt-1",children:s.description}):null]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-4 gap-3 items-end",children:[e.jsxs("div",{children:[e.jsx(_,{htmlFor:`price_${s.id}`,children:"Price/day (USD)"}),e.jsx(w,{id:`price_${s.id}`,type:"number",min:0,value:U[s.id]??"",onChange:a=>F(t=>({...t,[s.id]:a.target.value}))})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:`price_week_${s.id}`,children:"Price/week (USD)"}),e.jsx(w,{id:`price_week_${s.id}`,type:"number",min:0,value:W[s.id]??"",onChange:a=>q(t=>({...t,[s.id]:a.target.value}))})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:`price_month_${s.id}`,children:"Price/month (USD)"}),e.jsx(w,{id:`price_month_${s.id}`,type:"number",min:0,value:O[s.id]??"",onChange:a=>z(t=>({...t,[s.id]:a.target.value}))})]}),e.jsx("div",{className:"flex gap-2",children:e.jsx(o,{type:"button",onClick:()=>re(s.id),disabled:H===s.id,className:"bg-blue-600 hover:bg-blue-700 w-full",children:H===s.id?"Approving…":"Approve"})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(_,{htmlFor:`reject_${s.id}`,children:"Reject reason (optional)"}),e.jsx(me,{id:`reject_${s.id}`,value:G[s.id]??"",onChange:a=>ne(t=>({...t,[s.id]:a.target.value})),placeholder:"What needs to be fixed before approval?"})]}),e.jsx("div",{className:"flex items-end",children:e.jsx(o,{type:"button",variant:"outline",onClick:()=>le(s.id),disabled:V===s.id,children:V===s.id?"Rejecting…":"Reject"})})]})]},s.id)),e.jsx("div",{className:"flex gap-3",children:e.jsx(o,{type:"button",variant:"outline",onClick:y,disabled:P,children:"Refresh"})})]})]}),e.jsxs(u,{className:"shadow-lg",children:[e.jsxs(x,{children:[e.jsx(h,{children:"All partner listings"}),e.jsx(g,{children:P?"Loading…":`${j.length} total`})]}),e.jsx(v,{className:"space-y-3",children:j.map(s=>e.jsxs("div",{className:"p-4 bg-white border rounded-lg flex flex-col sm:flex-row sm:justify-between gap-2",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"font-semibold text-gray-900",children:s.name}),e.jsxs("p",{className:"text-gray-600 capitalize",children:[s.category," · ",e.jsx("span",{className:"font-semibold",children:s.listing_status})]}),s.rejection_reason?e.jsxs("p",{className:"text-red-600",children:["Reason: ",s.rejection_reason]}):null]}),e.jsxs("div",{className:"text-sm text-gray-800",children:[e.jsxs("p",{children:["Price/day: ",e.jsx("span",{className:"font-semibold",children:s.price_per_day?`$${d(s.price_per_day)}`:"—"})]}),e.jsxs("p",{children:["Price/week: ",e.jsx("span",{className:"font-semibold",children:s.price_per_week?`$${d(s.price_per_week)}`:"—"})]}),e.jsxs("p",{children:["Price/month: ",e.jsx("span",{className:"font-semibold",children:s.price_per_month?`$${d(s.price_per_month)}`:"—"})]}),e.jsx("p",{className:s.active?"text-green-700 font-semibold":"text-gray-600 font-semibold",children:s.active?"Active":"Inactive"})]})]},s.id))})]})]}),e.jsx(D,{value:"bookings",className:"mt-6 space-y-6",children:e.jsxs(u,{className:"shadow-lg",children:[e.jsxs(x,{children:[e.jsx(h,{children:"Recent bookings"}),e.jsx(g,{children:K?"Loading…":`${Q.length} shown`})]}),e.jsxs(v,{className:"space-y-4",children:[Q.map(s=>e.jsxs("div",{className:"p-4 bg-white border rounded-lg space-y-3",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:justify-between gap-3",children:[e.jsxs("div",{className:"text-sm",children:[e.jsxs("p",{className:"font-semibold text-gray-900",children:["Booking ",e.jsx("code",{className:"break-all",children:s.id})]}),e.jsxs("p",{className:"text-gray-700",children:[s.start_date," → ",s.end_date]}),e.jsxs("p",{className:"text-gray-700",children:["Status: ",e.jsx("span",{className:"font-semibold",children:s.status})]}),s.completed_at?e.jsxs("p",{className:"text-green-700 font-semibold",children:["Completed at: ",s.completed_at]}):null]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(o,{type:"button",variant:"outline",onClick:()=>te(s.id,"confirmed"),disabled:f===s.id,children:"Confirm"}),e.jsx(o,{type:"button",variant:"outline",onClick:()=>te(s.id,"cancelled"),disabled:f===s.id,children:"Cancel"}),e.jsx(o,{type:"button",onClick:()=>ce(s.id),disabled:f===s.id,className:"bg-blue-600 hover:bg-blue-700",children:f===s.id?"Working…":"Complete + create payouts"})]})]}),e.jsxs("div",{className:"text-sm text-gray-800",children:[e.jsx("p",{className:"font-semibold",children:"Items"}),e.jsx("ul",{className:"mt-2 space-y-1",children:(s.booking_items||[]).map(a=>{const t=a.vehicles,n=!!t?.owner_user_id;return e.jsxs("li",{className:"flex flex-col sm:flex-row sm:justify-between gap-1",children:[e.jsxs("span",{children:[t?.name||a.vehicle_id," × ",a.quantity," ",n?"(Partner)":"(Rivercity)"]}),a.unit_price_per_day?e.jsxs("span",{children:["$",d(a.unit_price_per_day),"/day"]}):e.jsx("span",{className:"text-gray-500",children:"price snapshot missing"})]},a.id)})})]})]},s.id)),e.jsx("div",{className:"flex gap-3",children:e.jsx(o,{type:"button",variant:"outline",onClick:N,disabled:K,children:"Refresh"})})]})]})}),e.jsx(D,{value:"payouts",className:"mt-6 space-y-6",children:e.jsxs(u,{className:"shadow-lg",children:[e.jsxs(x,{children:[e.jsx(h,{children:"Manual payouts"}),e.jsx(g,{children:J?"Loading…":`${L.length} shown`})]}),e.jsxs(v,{className:"space-y-4",children:[L.length===0?e.jsx("p",{className:"text-gray-700",children:"No payouts yet."}):null,L.map(s=>e.jsxs("div",{className:"p-4 bg-white border rounded-lg space-y-3",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:justify-between gap-3",children:[e.jsxs("div",{className:"text-sm",children:[e.jsxs("p",{className:"font-semibold text-gray-900",children:["Payout ",e.jsx("code",{className:"break-all",children:s.id})]}),e.jsxs("p",{className:"text-gray-700",children:["Booking: ",e.jsx("code",{className:"break-all",children:s.booking_id})]}),e.jsxs("p",{className:"text-gray-700",children:["Status: ",e.jsx("span",{className:"font-semibold",children:s.status})]}),e.jsxs("p",{className:he(s.eligible_at)?"text-green-700 font-semibold":"text-gray-700",children:["Eligible at: ",s.eligible_at]}),s.paid_at?e.jsxs("p",{className:"text-green-700 font-semibold",children:["Paid at: ",s.paid_at]}):null]}),e.jsxs("div",{className:"text-sm text-gray-800",children:[e.jsxs("p",{children:["Gross: ",e.jsxs("span",{className:"font-semibold",children:["$",d(s.gross_amount)]})]}),e.jsxs("p",{children:["Fee (30%): ",e.jsxs("span",{className:"font-semibold",children:["$",d(s.platform_fee_amount)]})]}),e.jsxs("p",{children:["Net (70%): ",e.jsxs("span",{className:"font-semibold",children:["$",d(s.net_amount)]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"text-sm text-gray-800",children:[e.jsx("p",{className:"font-semibold",children:"Owner payout details"}),e.jsxs("p",{children:["Name: ",s.owner_profiles?.full_name||"—"]}),e.jsxs("p",{children:["Phone: ",s.owner_profiles?.phone||"—"]}),e.jsxs("p",{children:["Bank: ",s.owner_profiles?.bank_name||"—"]}),e.jsxs("p",{children:["Account name: ",s.owner_profiles?.bank_account_name||"—"]}),e.jsxs("p",{children:["Account number: ",s.owner_profiles?.bank_account_number||"—"]}),s.owner_profiles?.bank_branch?e.jsxs("p",{children:["Branch: ",s.owner_profiles.bank_branch]}):null,s.owner_profiles?.payout_notes?e.jsxs("p",{className:"text-gray-600",children:["Notes: ",s.owner_profiles.payout_notes]}):null]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{htmlFor:`payref_${s.id}`,children:"Payment reference (optional)"}),e.jsx(w,{id:`payref_${s.id}`,value:se[s.id]??"",onChange:a=>ae(t=>({...t,[s.id]:a.target.value})),placeholder:"Bank transfer reference"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(o,{type:"button",onClick:()=>de(s.id),disabled:Z===s.id||s.status==="paid",className:"bg-blue-600 hover:bg-blue-700",children:Z===s.id?"Saving…":"Mark paid"}),e.jsx(o,{type:"button",variant:"outline",onClick:k,disabled:J,children:"Refresh"})]})]})]})]},s.id))]})]})})]})]})]})};export{be as default};
